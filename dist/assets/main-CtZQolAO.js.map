{"version":3,"file":"main-CtZQolAO.js","sources":["../../js/supabase.js","../../main.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\n// Configurazione Supabase - Credenziali aggiornate\r\nconst supabaseUrl = 'https://rixnizceeggdhlridwrj.supabase.co'\r\nconst supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeG5pemNlZWdnZGhscmlkd3JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNDY5MzQsImV4cCI6MjA3MzYyMjkzNH0.3YPTcW2_cfS0NCLimGpU2xpp8T5C8LPv-bluQtDB3vQ'\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\r\n\r\n// Classe per gestire l'autenticazione\r\nexport class AuthManager {\r\n  static async signUp(email, password) {\r\n    const { data, error } = await supabase.auth.signUp({\r\n      email,\r\n      password,\r\n      options: {\r\n        emailRedirectTo: window.location.origin\r\n      }\r\n    })\r\n    return { data, error }\r\n  }\r\n\r\n  static async signIn(email, password) {\r\n    const { data, error } = await supabase.auth.signInWithPassword({\r\n      email,\r\n      password\r\n    })\r\n    return { data, error }\r\n  }\r\n\r\n  static async signOut() {\r\n    const { error } = await supabase.auth.signOut()\r\n    return { error }\r\n  }\r\n\r\n  static async getCurrentUser() {\r\n    const { data: { user }, error } = await supabase.auth.getUser()\r\n    return { user, error }\r\n  }\r\n\r\n  static onAuthStateChange(callback) {\r\n    return supabase.auth.onAuthStateChange(callback)\r\n  }\r\n}\r\n\r\n// Classe per gestire le flashcard\r\nexport class FlashcardManager {\r\n  static async createFlashcardSet(name, description, subject, isPublic = false) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase\r\n      .from('flashcard_sets')\r\n      .insert({\r\n        user_id: user.id,\r\n        name,\r\n        description,\r\n        subject,\r\n        is_public: isPublic\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async addFlashcards(setId, flashcards) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const flashcardsToInsert = flashcards.map((card, index) => ({\r\n      set_id: setId,\r\n      question: card.domanda,\r\n      answer: card.risposta,\r\n      difficulty: card.difficulty || 2,\r\n      order_index: index\r\n    }))\r\n\r\n    const { data, error } = await supabase\r\n      .from('flashcards')\r\n      .insert(flashcardsToInsert)\r\n      .select()\r\n\r\n    // Aggiorna il contatore delle flashcard nel set\r\n    if (!error) {\r\n      await supabase\r\n        .from('flashcard_sets')\r\n        .update({ total_cards: flashcards.length })\r\n        .eq('id', setId)\r\n    }\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async getUserFlashcardSets() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase\r\n      .from('flashcard_sets')\r\n      .select(`\r\n        *,\r\n        flashcards (*)\r\n      `)\r\n      .eq('user_id', user.id)\r\n      .order('created_at', { ascending: false })\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async getFlashcardSet(setId) {\r\n    const { data, error } = await supabase\r\n      .from('flashcard_sets')\r\n      .select(`\r\n        *,\r\n        flashcards (*)\r\n      `)\r\n      .eq('id', setId)\r\n      .single()\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async deleteFlashcardSet(setId) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { error } = await supabase\r\n      .from('flashcard_sets')\r\n      .delete()\r\n      .eq('id', setId)\r\n      .eq('user_id', user.id)\r\n\r\n    return { error }\r\n  }\r\n\r\n  static async getPublicFlashcardSets() {\r\n    const { data, error } = await supabase\r\n      .from('flashcard_sets')\r\n      .select(`\r\n        *,\r\n        flashcards (*)\r\n      `)\r\n      .eq('is_public', true)\r\n      .order('created_at', { ascending: false })\r\n\r\n    return { data, error }\r\n  }\r\n}\r\n\r\n// Classe per la ripetizione spaziata avanzata (SM-2 Algorithm + Analytics)\r\nexport class SpacedRepetition {\r\n  static async calculateNext(quality, repetitions = 0, easeFactor = 2.5, interval = 1, userStats = {}) {\r\n    // Ottieni statistiche utente se non fornite\r\n    if (!userStats || Object.keys(userStats).length === 0) {\r\n      userStats = await this.getUserPerformanceStats() || {};\r\n    }\r\n\r\n    if (quality < 3) {\r\n      // Risposta sbagliata - ricomincia con penalità\r\n      const penalty = this.calculatePenalty(userStats);\r\n      return {\r\n        repetitions: 0,\r\n        interval: 1,\r\n        easeFactor: Math.max(1.3, easeFactor - 0.2 - penalty),\r\n        nextReview: new Date(Date.now() + 24 * 60 * 60 * 1000) // Domani\r\n      }\r\n    }\r\n\r\n    // Calcola ease factor con personalizzazione\r\n    const qualityFactor = this.getQualityFactor(quality);\r\n    let newEaseFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));\r\n    newEaseFactor = Math.max(1.3, Math.min(3.0, newEaseFactor));\r\n    \r\n    // Applica bonus per performance consistenti\r\n    if (userStats.consistency > 0.8) {\r\n      newEaseFactor = Math.min(3.0, newEaseFactor + 0.1);\r\n    }\r\n    \r\n    // Calcola intervallo personalizzato\r\n    let newInterval\r\n    if (repetitions === 0) {\r\n      newInterval = 1\r\n    } else if (repetitions === 1) {\r\n      newInterval = 6\r\n    } else {\r\n      const personalizationFactor = this.getPersonalizationFactor(userStats);\r\n      newInterval = Math.round(interval * newEaseFactor * personalizationFactor)\r\n    }\r\n\r\n    return {\r\n      repetitions: repetitions + 1,\r\n      interval: newInterval,\r\n      easeFactor: newEaseFactor,\r\n      nextReview: new Date(Date.now() + newInterval * 24 * 60 * 60 * 1000),\r\n      difficulty: this.calculateDifficulty(quality, newEaseFactor, userStats)\r\n    }\r\n  }\r\n\r\n  static calculatePenalty(userStats) {\r\n    // Penalità basata su errori recenti\r\n    if (userStats.recentErrors > 3) return 0.3;\r\n    if (userStats.recentErrors > 1) return 0.1;\r\n    return 0;\r\n  }\r\n\r\n  static getPersonalizationFactor(userStats) {\r\n    // Fattore di personalizzazione basato su analytics\r\n    const avgAccuracy = userStats.accuracy || 0.8;\r\n    \r\n    // Utenti con alta accuratezza possono avere intervalli più lunghi\r\n    if (avgAccuracy > 0.9) return 1.2;\r\n    if (avgAccuracy > 0.8) return 1.1;\r\n    if (avgAccuracy < 0.6) return 0.8;\r\n    \r\n    return 1.0;\r\n  }\r\n\r\n  static getQualityFactor(quality) {\r\n    // Fattore qualità per calcolo ease factor\r\n    const factors = {\r\n      5: 0.15,  // Perfetto\r\n      4: 0.1,   // Facile\r\n      3: 0.05,  // Normale\r\n      2: -0.1,  // Difficile\r\n      1: -0.2   // Molto difficile\r\n    };\r\n    return factors[quality] || 0;\r\n  }\r\n\r\n  static calculateDifficulty(quality, easeFactor, userStats) {\r\n    // Calcola difficoltà dinamica basata su performance\r\n    let difficulty = 2; // Default\r\n    \r\n    if (quality >= 4) {\r\n      difficulty = Math.max(1, difficulty - 0.5);\r\n    } else if (quality <= 2) {\r\n      difficulty = Math.min(5, difficulty + 0.5);\r\n    }\r\n    \r\n    // Aggiusta basato su ease factor\r\n    if (easeFactor > 2.5) difficulty = Math.max(1, difficulty - 0.3);\r\n    if (easeFactor < 1.8) difficulty = Math.min(5, difficulty + 0.3);\r\n    \r\n    return Math.round(difficulty * 10) / 10; // Arrotonda a 1 decimale\r\n  }\r\n\r\n  static async getUserPerformanceStats() {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return null;\r\n\r\n      const { data, error } = await supabase\r\n        .from('study_analytics')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .gte('date', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])\r\n        .order('date', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      // Calcola statistiche aggregate\r\n      const totalCards = data.reduce((sum, day) => sum + day.cards_studied, 0);\r\n      const totalCorrect = data.reduce((sum, day) => sum + day.correct_answers, 0);\r\n      const totalIncorrect = data.reduce((sum, day) => sum + day.incorrect_answers, 0);\r\n      \r\n      return {\r\n        totalCards,\r\n        accuracy: totalCards > 0 ? totalCorrect / totalCards : 0,\r\n        studyDays: data.length,\r\n        avgCardsPerDay: data.length > 0 ? totalCards / data.length : 0,\r\n        consistency: this.calculateConsistency(data),\r\n        recentErrors: this.calculateRecentErrors(data)\r\n      };\r\n    } catch (error) {\r\n      console.error('Errore nel calcolo statistiche performance:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  static calculateConsistency(data) {\r\n    if (data.length < 3) return 0;\r\n    \r\n    const studyDays = data.filter(day => day.cards_studied > 0).length;\r\n    const totalDays = data.length;\r\n    \r\n    return studyDays / totalDays;\r\n  }\r\n\r\n  static calculateRecentErrors(data) {\r\n    // Conta errori negli ultimi 3 giorni\r\n    const recentData = data.slice(0, 3);\r\n    return recentData.reduce((sum, day) => sum + day.incorrect_answers, 0);\r\n  }\r\n\r\n  static async recordStudySession(cardId, quality, sessionData = {}) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    // Ottieni la sessione di studio esistente\r\n    const { data: existingSession } = await supabase\r\n      .from('study_sessions')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n      .eq('card_id', cardId)\r\n      .single()\r\n\r\n    // Ottieni statistiche utente per personalizzazione\r\n    const userStats = await this.getUserPerformanceStats()\r\n\r\n    let newData\r\n    if (existingSession) {\r\n      newData = await this.calculateNext(\r\n        quality,\r\n        existingSession.repetitions,\r\n        existingSession.ease_factor,\r\n        existingSession.interval_days,\r\n        userStats\r\n      )\r\n    } else {\r\n      newData = await this.calculateNext(quality, 0, 2.5, 1, userStats)\r\n    }\r\n\r\n    // Salva o aggiorna la sessione di studio\r\n    const sessionRecord = {\r\n      user_id: user.id,\r\n      card_id: cardId,\r\n      quality,\r\n      ease_factor: newData.easeFactor,\r\n      interval_days: newData.interval,\r\n      next_review_date: newData.nextReview.toISOString().split('T')[0],\r\n      repetitions: newData.repetitions,\r\n      studied_at: new Date().toISOString(),\r\n      response_time: sessionData.responseTime || null,\r\n      study_mode: sessionData.mode || 'spaced_repetition',\r\n      device_type: sessionData.deviceType || 'desktop'\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('study_sessions')\r\n      .upsert(sessionRecord, { \r\n        onConflict: 'user_id,card_id',\r\n        ignoreDuplicates: false \r\n      })\r\n      .select()\r\n\r\n    // Aggiorna analytics utente\r\n    if (!error) {\r\n      await this.updateUserAnalytics(user.id, quality, sessionData)\r\n    }\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async updateUserAnalytics(userId, quality, sessionData) {\r\n    try {\r\n      // Aggiorna statistiche giornaliere\r\n      const today = new Date().toISOString().split('T')[0]\r\n      \r\n      const { data: existing, error: fetchError } = await supabase\r\n        .from('study_analytics')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .eq('date', today)\r\n        .single()\r\n      \r\n      if (fetchError && fetchError.code !== 'PGRST116') {\r\n        throw fetchError\r\n      }\r\n      \r\n      const updateData = {\r\n        user_id: userId,\r\n        date: today,\r\n        cards_studied: (existing?.cards_studied || 0) + 1,\r\n        correct_answers: (existing?.correct_answers || 0) + (quality >= 3 ? 1 : 0),\r\n        incorrect_answers: (existing?.incorrect_answers || 0) + (quality < 3 ? 1 : 0),\r\n        study_time_minutes: (existing?.study_time_minutes || 0) + (sessionData.duration || 0),\r\n        updated_at: new Date().toISOString()\r\n      }\r\n      \r\n      if (existing) {\r\n        const { error } = await supabase\r\n          .from('study_analytics')\r\n          .update(updateData)\r\n          .eq('id', existing.id)\r\n        \r\n        if (error) throw error\r\n      } else {\r\n        const { error } = await supabase\r\n          .from('study_analytics')\r\n          .insert(updateData)\r\n        \r\n        if (error) throw error\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Errore nell\\'aggiornamento analytics:', error)\r\n    }\r\n  }\r\n\r\n  static async getCardsForReview() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const today = new Date().toISOString().split('T')[0]\r\n\r\n    const { data, error } = await supabase\r\n      .from('study_sessions')\r\n      .select(`\r\n        *,\r\n        flashcards (\r\n          *,\r\n          flashcard_sets (*)\r\n        )\r\n      `)\r\n      .eq('user_id', user.id)\r\n      .lte('next_review_date', today)\r\n      .order('next_review_date', { ascending: true })\r\n\r\n    return { data, error }\r\n  }\r\n}\r\n\r\n// Classe per gestire l'API usage\r\nexport class ApiUsageManager {\r\n  static async checkDailyLimit() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const today = new Date().toISOString().split('T')[0]\r\n    const { data, error } = await supabase\r\n      .from('api_usage')\r\n      .select('tokens_used')\r\n      .eq('user_id', user.id)\r\n      .eq('request_date', today)\r\n      .single()\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async incrementUsage() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const today = new Date().toISOString().split('T')[0]\r\n    const { data, error } = await supabase\r\n      .from('api_usage')\r\n      .upsert({\r\n        user_id: user.id,\r\n        request_date: today,\r\n        tokens_used: 1\r\n      }, {\r\n        onConflict: 'user_id,request_date',\r\n        ignoreDuplicates: false\r\n      })\r\n      .select()\r\n\r\n    return { data, error }\r\n  }\r\n}\r\n\r\n// Funzione per chiamare l'Edge Function\r\nexport async function generateFlashcardsWithAI(text, difficulty = 'medio', subject = '', cardCount = 10) {\r\n  const { data: { session } } = await supabase.auth.getSession()\r\n  if (!session) throw new Error('Utente non autenticato')\r\n\r\n  const { data, error } = await supabase.functions.invoke('generate-flashcards', {\r\n    body: {\r\n      text,\r\n      difficulty,\r\n      subject,\r\n      cardCount\r\n    },\r\n    headers: {\r\n      Authorization: `Bearer ${session.access_token}`\r\n    }\r\n  })\r\n\r\n  return { data, error }\r\n}\r\n\r\n// Classe per gestire Analytics\r\nexport class AnalyticsManager {\r\n  static async getUserAnalytics(daysBack = 30) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase.rpc('get_user_analytics', {\r\n      user_uuid: user.id,\r\n      days_back: daysBack\r\n    })\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async recordStudySession(sessionData) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase\r\n      .from('study_sessions_detailed')\r\n      .insert({\r\n        user_id: user.id,\r\n        ...sessionData\r\n      })\r\n      .select()\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async updateDailyAnalytics(cardsStudied, correctAnswers, studyTimeMinutes) {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const today = new Date().toISOString().split('T')[0]\r\n\r\n    const { data, error } = await supabase\r\n      .from('study_analytics')\r\n      .upsert({\r\n        user_id: user.id,\r\n        date: today,\r\n        cards_studied: cardsStudied,\r\n        correct_answers: correctAnswers,\r\n        incorrect_answers: cardsStudied - correctAnswers,\r\n        study_time_minutes: studyTimeMinutes\r\n      }, {\r\n        onConflict: 'user_id,date',\r\n        ignoreDuplicates: false\r\n      })\r\n      .select()\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async getWeeklyProgress() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase\r\n      .from('study_analytics')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n      .gte('date', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])\r\n      .order('date', { ascending: true })\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static async getCardsForReview() {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) throw new Error('Utente non autenticato')\r\n\r\n    const { data, error } = await supabase.rpc('get_cards_for_review', {\r\n      user_uuid: user.id\r\n    })\r\n\r\n    return { data, error }\r\n  }\r\n\r\n  static generateInsights(analytics) {\r\n    const insights = []\r\n\r\n    // Insight 1: Streak\r\n    if (analytics.study_streak > 0) {\r\n      insights.push({\r\n        icon: '🔥',\r\n        title: `Streak di ${analytics.study_streak} giorni!`,\r\n        description: analytics.study_streak >= 7 \r\n          ? 'Fantastico! Mantieni questo ritmo per consolidare le tue conoscenze.'\r\n          : 'Continua così! Ogni giorno di studio conta per il tuo apprendimento.'\r\n      })\r\n    }\r\n\r\n    // Insight 2: Accuratezza\r\n    if (analytics.accuracy_rate > 0) {\r\n      if (analytics.accuracy_rate >= 80) {\r\n        insights.push({\r\n          icon: '🎯',\r\n          title: 'Eccellente accuratezza!',\r\n          description: `Con il ${analytics.accuracy_rate}% di risposte corrette, stai padroneggiando bene i contenuti.`\r\n        })\r\n      } else if (analytics.accuracy_rate < 60) {\r\n        insights.push({\r\n          icon: '📚',\r\n          title: 'Focus sul ripasso',\r\n          description: `La tua accuratezza è del ${analytics.accuracy_rate}%. Considera di ripassare i contenuti più difficili.`\r\n        })\r\n      }\r\n    }\r\n\r\n    // Insight 3: Tempo di studio\r\n    if (analytics.total_study_time > 0) {\r\n      const hours = Math.round(analytics.total_study_time / 60)\r\n      if (hours >= 10) {\r\n        insights.push({\r\n          icon: '⏰',\r\n          title: 'Studio intensivo!',\r\n          description: `Hai studiato ${hours} ore negli ultimi 30 giorni. Ottimo impegno!`\r\n        })\r\n      }\r\n    }\r\n\r\n    // Insight 4: Carte da ripassare\r\n    if (analytics.cards_due_today > 0) {\r\n      insights.push({\r\n        icon: '📅',\r\n        title: 'Carte in attesa',\r\n        description: `Hai ${analytics.cards_due_today} carte da ripassare oggi. Non dimenticare di studiare!`\r\n      })\r\n    }\r\n\r\n    // Insight 5: Progresso generale\r\n    if (analytics.total_cards > 0) {\r\n      insights.push({\r\n        icon: '📈',\r\n        title: 'Progresso costante',\r\n        description: `Hai creato ${analytics.total_cards} flashcard in ${analytics.total_sets} set. Continua a espandere le tue conoscenze!`\r\n      })\r\n    }\r\n\r\n    return insights\r\n  }\r\n}\r\n\r\n// Utility per gestire errori\r\nexport function handleSupabaseError(error) {\r\n  console.error('Supabase Error:', error)\r\n  \r\n  if (error.message.includes('JWT')) {\r\n    return 'Sessione scaduta. Effettua nuovamente l\\'accesso.'\r\n  }\r\n  \r\n  if (error.message.includes('permission')) {\r\n    return 'Non hai i permessi per eseguire questa operazione.'\r\n  }\r\n  \r\n  if (error.message.includes('network')) {\r\n    return 'Errore di connessione. Verifica la tua connessione internet.'\r\n  }\r\n  \r\n  return error.message || 'Si è verificato un errore imprevisto.'\r\n}\r\n","// Entry point principale per Vite\r\nimport { \r\n    AuthManager, \r\n    FlashcardManager, \r\n    SpacedRepetition, \r\n    AnalyticsManager,\r\n    generateFlashcardsWithAI,\r\n    handleSupabaseError \r\n} from './js/supabase.js';\r\n\r\n// Importa Recharts per grafici\r\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } from 'recharts';\r\n\r\n// Esponi le librerie globalmente per compatibilità\r\nwindow.Recharts = { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar };\r\n\r\n// Configurazione globale\r\nconst CONFIG = {\r\n    DEFAULT_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',\r\n    // API Key rimosso per sicurezza - usa Edge Function Supabase\r\n    STORAGE_KEY: 'flashcard_api_key',\r\n    THEME_KEY: 'flashcard_theme',\r\n    SAVED_SETS_KEY: 'flashcard_saved_sets'\r\n};\r\n\r\n// Stato dell'applicazione\r\nlet appState = {\r\n    flashcards: [],\r\n    currentIndex: 0,\r\n    isLoading: false,\r\n    apiKey: null,\r\n    useCustomApi: false,\r\n    answerRevealed: false,\r\n    user: null,\r\n    studyMode: false,\r\n    studyCards: [],\r\n    currentStudyIndex: 0,\r\n    cardsStudiedToday: 0,\r\n    studyStartTime: null,\r\n    selectedStudyMode: null,\r\n    quizData: [],\r\n    matchingData: [],\r\n    memoryData: [],\r\n    speedData: [],\r\n    quizScore: 0,\r\n    matchingScore: 0,\r\n    memoryScore: 0,\r\n    speedScore: 0\r\n};\r\n\r\n// Elementi DOM\r\nconst elements = {\r\n    // Autenticazione\r\n    authSection: document.getElementById('authSection'),\r\n    loginForm: document.getElementById('loginForm'),\r\n    userInfo: document.getElementById('userInfo'),\r\n    emailInput: document.getElementById('emailInput'),\r\n    passwordInput: document.getElementById('passwordInput'),\r\n    loginBtn: document.getElementById('loginBtn'),\r\n    signupBtn: document.getElementById('signupBtn'),\r\n    logoutBtn: document.getElementById('logoutBtn'),\r\n    userEmail: document.getElementById('userEmail'),\r\n    userStats: document.getElementById('userStats'),\r\n    analyticsBtn: document.getElementById('analyticsBtn'),\r\n    \r\n    // Input\r\n    textInput: document.getElementById('textInput'),\r\n    pdfInput: document.getElementById('pdfInput'),\r\n    pdfInfo: document.getElementById('pdfInfo'),\r\n    apiChoiceRadios: document.querySelectorAll('input[name=\"apiChoice\"]'),\r\n    customApiSection: document.getElementById('customApiSection'),\r\n    apiKeyInput: document.getElementById('apiKeyInput'),\r\n    saveApiKeyBtn: document.getElementById('saveApiKey'),\r\n    generateBtn: document.getElementById('generateBtn'),\r\n    \r\n    // Flashcard\r\n    flashcardSection: document.getElementById('flashcardSection'),\r\n    flashcardCounter: document.getElementById('flashcardCounter'),\r\n    currentCard: document.getElementById('currentCard'),\r\n    totalCards: document.getElementById('totalCards'),\r\n    questionText: document.getElementById('questionText'),\r\n    answerText: document.getElementById('answerText'),\r\n    answerSection: document.getElementById('answerSection'),\r\n    revealAnswerBtn: document.getElementById('revealAnswerBtn'),\r\n    prevBtn: document.getElementById('prevBtn'),\r\n    nextBtn: document.getElementById('nextBtn'),\r\n    saveSetBtn: document.getElementById('saveSetBtn'),\r\n    exportBtn: document.getElementById('exportBtn'),\r\n    copyBtn: document.getElementById('copyBtn'),\r\n    \r\n    // Analytics\r\n    analyticsSection: document.getElementById('analyticsSection'),\r\n    analyticsTimeframe: document.getElementById('analyticsTimeframe'),\r\n    refreshAnalytics: document.getElementById('refreshAnalytics'),\r\n    totalSets: document.getElementById('totalSets'),\r\n    totalCards: document.getElementById('totalCards'),\r\n    studyStreak: document.getElementById('studyStreak'),\r\n    accuracyRate: document.getElementById('accuracyRate'),\r\n    totalStudyTime: document.getElementById('totalStudyTime'),\r\n    cardsDueToday: document.getElementById('cardsDueToday'),\r\n    weeklyProgressChart: document.getElementById('weeklyProgressChart'),\r\n    accuracyChart: document.getElementById('accuracyChart'),\r\n    insightsList: document.getElementById('insightsList'),\r\n    \r\n    // Studio\r\n    studySection: document.getElementById('studySection'),\r\n    startStudyBtn: document.getElementById('startStudyBtn'),\r\n    stopStudyBtn: document.getElementById('stopStudyBtn'),\r\n    cardsDue: document.getElementById('cardsDue'),\r\n    cardsStudied: document.getElementById('cardsStudied'),\r\n    currentStudyMode: document.getElementById('currentStudyMode'),\r\n    studyCard: document.getElementById('studyCard'),\r\n    studyProgress: document.getElementById('studyProgress'),\r\n    studyProgressText: document.getElementById('studyProgressText'),\r\n    studyQuestionText: document.getElementById('studyQuestionText'),\r\n    studyRevealBtn: document.getElementById('studyRevealBtn'),\r\n    studyAnswer: document.getElementById('studyAnswer'),\r\n    studyAnswerText: document.getElementById('studyAnswerText'),\r\n    \r\n    // Modalità Studio\r\n    studyModeCards: document.querySelectorAll('.study-mode-card'),\r\n    studyModeSelector: document.querySelector('.study-mode-selector'),\r\n    \r\n    // Quiz Mode\r\n    quizMode: document.getElementById('quizMode'),\r\n    quizQuestion: document.getElementById('quizQuestionText'),\r\n    quizOptions: document.getElementById('quizOptions'),\r\n    quizFeedback: document.getElementById('quizFeedback'),\r\n    feedbackIcon: document.getElementById('feedbackIcon'),\r\n    feedbackText: document.getElementById('feedbackText'),\r\n    correctAnswer: document.getElementById('correctAnswer'),\r\n    nextQuizBtn: document.getElementById('nextQuizBtn'),\r\n    quizProgress: document.getElementById('quizProgress'),\r\n    quizProgressText: document.getElementById('quizProgressText'),\r\n    \r\n    // Matching Mode\r\n    matchingMode: document.getElementById('matchingMode'),\r\n    matchingGrid: document.getElementById('matchingGrid'),\r\n    matchingFeedback: document.getElementById('matchingFeedback'),\r\n    matchingFeedbackIcon: document.getElementById('matchingFeedbackIcon'),\r\n    matchingFeedbackText: document.getElementById('matchingFeedbackText'),\r\n    matchingProgress: document.getElementById('matchingProgress'),\r\n    matchingProgressText: document.getElementById('matchingProgressText'),\r\n    \r\n    // Memory Mode\r\n    memoryMode: document.getElementById('memoryMode'),\r\n    memoryGrid: document.getElementById('memoryGrid'),\r\n    memoryAttempts: document.getElementById('memoryAttempts'),\r\n    memoryPairs: document.getElementById('memoryPairs'),\r\n    memoryProgress: document.getElementById('memoryProgress'),\r\n    memoryProgressText: document.getElementById('memoryProgressText'),\r\n    \r\n    // Speed Mode\r\n    speedMode: document.getElementById('speedMode'),\r\n    speedQuestion: document.getElementById('speedQuestionText'),\r\n    speedAnswer: document.getElementById('speedAnswerText'),\r\n    speedTimer: document.getElementById('speedTimer'),\r\n    revealSpeedAnswer: document.getElementById('revealSpeedAnswer'),\r\n    speedNext: document.getElementById('speedNext'),\r\n    speedProgress: document.getElementById('speedProgress'),\r\n    speedProgressText: document.getElementById('speedProgressText'),\r\n    \r\n    // Flashcard salvate\r\n    savedFlashcardsSection: document.getElementById('savedFlashcardsSection'),\r\n    savedSetsGrid: document.getElementById('savedSetsGrid'),\r\n    emptySavedSets: document.getElementById('emptySavedSets'),\r\n    refreshSetsBtn: document.getElementById('refreshSetsBtn'),\r\n    clearAllBtn: document.getElementById('clearAllBtn'),\r\n    \r\n    // Modal\r\n    exportModal: document.getElementById('exportModal'),\r\n    exportJson: document.getElementById('exportJson'),\r\n    exportCsv: document.getElementById('exportCsv'),\r\n    closeModal: document.getElementById('closeModal'),\r\n    saveSetModal: document.getElementById('saveSetModal'),\r\n    setNameInput: document.getElementById('setNameInput'),\r\n    confirmSaveBtn: document.getElementById('confirmSaveBtn'),\r\n    cancelSaveBtn: document.getElementById('cancelSaveBtn')\r\n};\r\n\r\n// Inizializzazione\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    initializeApp();\r\n    setupEventListeners();\r\n    loadSavedData();\r\n    checkAuthState();\r\n});\r\n\r\n// Inizializzazione dell'app\r\nfunction initializeApp() {\r\n    // Configura pdf.js con gestione errori\r\n    try {\r\n        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';\r\n    } catch (error) {\r\n        console.warn('PDF.js non disponibile:', error);\r\n    }\r\n    \r\n    // Aggiungi toggle tema\r\n    addThemeToggle();\r\n    \r\n    console.log('Flashcard Generator v2.0 inizializzato con Supabase');\r\n}\r\n\r\n// Setup degli event listeners\r\nfunction setupEventListeners() {\r\n    // Autenticazione\r\n    elements.loginBtn.addEventListener('click', handleLogin);\r\n    elements.signupBtn.addEventListener('click', handleSignup);\r\n    elements.logoutBtn.addEventListener('click', handleLogout);\r\n    elements.analyticsBtn.addEventListener('click', showAnalyticsDashboard);\r\n    \r\n    // Input text\r\n    elements.textInput.addEventListener('input', handleTextInput);\r\n    \r\n    // File PDF\r\n    elements.pdfInput.addEventListener('change', handlePdfUpload);\r\n    \r\n    // API choice\r\n    elements.apiChoiceRadios.forEach(radio => {\r\n        radio.addEventListener('change', handleApiChoiceChange);\r\n    });\r\n    \r\n    // Salva API key\r\n    elements.saveApiKeyBtn.addEventListener('click', saveApiKey);\r\n    \r\n    // Genera flashcard\r\n    elements.generateBtn.addEventListener('click', generateFlashcards);\r\n    \r\n    // Rivelare risposta\r\n    elements.revealAnswerBtn.addEventListener('click', toggleAnswer);\r\n    \r\n    // Navigazione flashcard\r\n    elements.prevBtn.addEventListener('click', showPreviousCard);\r\n    elements.nextBtn.addEventListener('click', showNextCard);\r\n    \r\n    // Salvataggio e esportazione\r\n    elements.saveSetBtn.addEventListener('click', showSaveSetModal);\r\n    elements.exportBtn.addEventListener('click', showExportModal);\r\n    elements.copyBtn.addEventListener('click', copyFlashcards);\r\n    elements.exportJson.addEventListener('click', () => exportFlashcards('json'));\r\n    elements.exportCsv.addEventListener('click', () => exportFlashcards('csv'));\r\n    elements.closeModal.addEventListener('click', hideExportModal);\r\n    \r\n    // Modal salvataggio set\r\n    elements.confirmSaveBtn.addEventListener('click', saveFlashcardSet);\r\n    elements.cancelSaveBtn.addEventListener('click', hideSaveSetModal);\r\n    elements.setNameInput.addEventListener('keypress', (e) => {\r\n        if (e.key === 'Enter') {\r\n            saveFlashcardSet();\r\n        }\r\n    });\r\n    \r\n    // Analytics\r\n    elements.analyticsTimeframe.addEventListener('change', loadAnalytics);\r\n    elements.refreshAnalytics.addEventListener('click', loadAnalytics);\r\n    \r\n    // Studio\r\n    elements.startStudyBtn.addEventListener('click', startStudyMode);\r\n    elements.stopStudyBtn.addEventListener('click', stopStudyMode);\r\n    elements.studyRevealBtn.addEventListener('click', revealStudyAnswer);\r\n    \r\n    // Rating buttons\r\n    document.addEventListener('click', (e) => {\r\n        if (e.target.classList.contains('rating-btn')) {\r\n            handleStudyRating(parseInt(e.target.dataset.quality));\r\n        }\r\n    });\r\n    \r\n    // Modalità Studio\r\n    elements.studyModeCards.forEach(card => {\r\n        card.addEventListener('click', selectStudyMode);\r\n    });\r\n    \r\n    // Quiz Mode\r\n    elements.nextQuizBtn.addEventListener('click', nextQuizQuestion);\r\n    \r\n    // Speed Mode\r\n    elements.revealSpeedAnswer.addEventListener('click', revealSpeedAnswer);\r\n    elements.speedNext.addEventListener('click', nextSpeedCard);\r\n    \r\n    // Gestione flashcard salvate\r\n    elements.refreshSetsBtn.addEventListener('click', loadSavedFlashcards);\r\n    elements.clearAllBtn.addEventListener('click', clearAllSavedSets);\r\n    \r\n    // Chiudi modal cliccando fuori\r\n    elements.exportModal.addEventListener('click', (e) => {\r\n        if (e.target === elements.exportModal) {\r\n            hideExportModal();\r\n        }\r\n    });\r\n    \r\n    elements.saveSetModal.addEventListener('click', (e) => {\r\n        if (e.target === elements.saveSetModal) {\r\n            hideSaveSetModal();\r\n        }\r\n    });\r\n}\r\n\r\n// Gestione autenticazione\r\nasync function checkAuthState() {\r\n    const { user } = await AuthManager.getCurrentUser();\r\n    if (user) {\r\n        appState.user = user;\r\n        showUserInfo();\r\n        loadSavedFlashcards();\r\n        updateStudyStats();\r\n    } else {\r\n        showLoginForm();\r\n    }\r\n}\r\n\r\nfunction showLoginForm() {\r\n    elements.loginForm.classList.remove('hidden');\r\n    elements.userInfo.classList.add('hidden');\r\n    appState.user = null;\r\n}\r\n\r\nfunction showUserInfo() {\r\n    elements.loginForm.classList.add('hidden');\r\n    elements.userInfo.classList.remove('hidden');\r\n    elements.userEmail.textContent = appState.user.email;\r\n    updateUserStats();\r\n}\r\n\r\nasync function updateUserStats() {\r\n    if (!appState.user) return;\r\n    \r\n    try {\r\n        const { data, error } = await AnalyticsManager.getUserAnalytics(30);\r\n        \r\n        if (error) throw error;\r\n        \r\n        const stats = data || {};\r\n        elements.userStats.textContent = `${stats.total_sets || 0} set • ${stats.total_cards || 0} carte`;\r\n    } catch (error) {\r\n        console.error('Errore nel caricamento delle statistiche:', error);\r\n    }\r\n}\r\n\r\nasync function handleLogin() {\r\n    const email = elements.emailInput.value.trim();\r\n    const password = elements.passwordInput.value.trim();\r\n    \r\n    if (!email || !password) {\r\n        showError('Inserisci email e password.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true);\r\n        const { data, error } = await AuthManager.signIn(email, password);\r\n        \r\n        if (error) throw error;\r\n        \r\n        appState.user = data.user;\r\n        showUserInfo();\r\n        loadSavedFlashcards();\r\n        updateStudyStats();\r\n        showSuccess('Accesso effettuato con successo!');\r\n        \r\n        // Pulisci i campi\r\n        elements.emailInput.value = '';\r\n        elements.passwordInput.value = '';\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\nasync function handleSignup() {\r\n    const email = elements.emailInput.value.trim();\r\n    const password = elements.passwordInput.value.trim();\r\n    \r\n    if (!email || !password) {\r\n        showError('Inserisci email e password.');\r\n        return;\r\n    }\r\n    \r\n    if (password.length < 6) {\r\n        showError('La password deve essere di almeno 6 caratteri.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true);\r\n        const { data, error } = await AuthManager.signUp(email, password);\r\n        \r\n        if (error) throw error;\r\n        \r\n        showSuccess('Registrazione completata! Controlla la tua email per confermare l\\'account.');\r\n        \r\n        // Pulisci i campi\r\n        elements.emailInput.value = '';\r\n        elements.passwordInput.value = '';\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\nasync function handleLogout() {\r\n    try {\r\n        const { error } = await AuthManager.signOut();\r\n        if (error) throw error;\r\n        \r\n        appState.user = null;\r\n        showLoginForm();\r\n        showSuccess('Logout effettuato con successo!');\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Gestione input testo\r\nfunction handleTextInput() {\r\n    const text = elements.textInput.value.trim();\r\n    if (text) {\r\n        elements.pdfInput.value = '';\r\n        elements.pdfInfo.classList.add('hidden');\r\n    }\r\n}\r\n\r\n// Gestione upload PDF\r\nasync function handlePdfUpload(event) {\r\n    const file = event.target.files[0];\r\n    if (!file) return;\r\n    \r\n    if (file.type !== 'application/pdf') {\r\n        showError('Per favore seleziona un file PDF valido.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true);\r\n        const text = await extractTextFromPdf(file);\r\n        elements.textInput.value = text;\r\n        elements.pdfInfo.textContent = `PDF caricato: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;\r\n        elements.pdfInfo.classList.remove('hidden');\r\n    } catch (error) {\r\n        showError('Errore nella lettura del PDF: ' + error.message);\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\n// Estrazione testo da PDF\r\nasync function extractTextFromPdf(file) {\r\n    return new Promise((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        reader.onload = async function(e) {\r\n            try {\r\n                const typedarray = new Uint8Array(e.target.result);\r\n                const pdf = await pdfjsLib.getDocument(typedarray).promise;\r\n                let fullText = '';\r\n                \r\n                for (let i = 1; i <= pdf.numPages; i++) {\r\n                    const page = await pdf.getPage(i);\r\n                    const textContent = await page.getTextContent();\r\n                    const pageText = textContent.items.map(item => item.str).join(' ');\r\n                    fullText += pageText + '\\n';\r\n                }\r\n                \r\n                resolve(fullText.trim());\r\n            } catch (error) {\r\n                reject(error);\r\n            }\r\n        };\r\n        reader.onerror = reject;\r\n        reader.readAsArrayBuffer(file);\r\n    });\r\n}\r\n\r\n// Gestione cambio scelta API\r\nfunction handleApiChoiceChange(event) {\r\n    const useCustom = event.target.value === 'custom';\r\n    appState.useCustomApi = useCustom;\r\n    \r\n    if (useCustom) {\r\n        elements.customApiSection.classList.remove('hidden');\r\n        elements.apiKeyInput.focus();\r\n    } else {\r\n        elements.customApiSection.classList.add('hidden');\r\n    }\r\n}\r\n\r\n// Salva API key\r\nfunction saveApiKey() {\r\n    const apiKey = elements.apiKeyInput.value.trim();\r\n    if (!apiKey) {\r\n        showError('Inserisci una API key valida.');\r\n        return;\r\n    }\r\n    \r\n    appState.apiKey = apiKey;\r\n    localStorage.setItem(CONFIG.STORAGE_KEY, apiKey);\r\n    showSuccess('API key salvata con successo!');\r\n}\r\n\r\n// Carica dati salvati\r\nfunction loadSavedData() {\r\n    // Carica API key\r\n    const savedApiKey = localStorage.getItem(CONFIG.STORAGE_KEY);\r\n    if (savedApiKey) {\r\n        appState.apiKey = savedApiKey;\r\n        elements.apiKeyInput.value = savedApiKey;\r\n    }\r\n    \r\n    // Carica tema\r\n    const savedTheme = localStorage.getItem(CONFIG.THEME_KEY) || 'light';\r\n    document.documentElement.setAttribute('data-theme', savedTheme);\r\n}\r\n\r\n// Genera flashcard\r\nasync function generateFlashcards() {\r\n    const text = elements.textInput.value.trim();\r\n    if (!text) {\r\n        showError('Inserisci del testo o carica un PDF per generare le flashcard.');\r\n        return;\r\n    }\r\n    \r\n    // Verifica API key se si usa API personalizzata\r\n    if (appState.useCustomApi && !appState.apiKey) {\r\n        showError('Inserisci la tua API key per continuare.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true, 'Analisi del testo in corso...');\r\n        let flashcards;\r\n        \r\n        if (appState.user) {\r\n            // Usa sempre Edge Function per utenti autenticati (sicuro)\r\n            showLoading(true, 'Generazione AI in corso...');\r\n            try {\r\n                const { data, error } = await generateFlashcardsWithAI(text, 'medio', '', 10);\r\n                if (error) throw error;\r\n                flashcards = data.flashcards;\r\n            } catch (edgeError) {\r\n                console.warn('Edge Function non disponibile, fallback a API diretta:', edgeError);\r\n                // Fallback a API diretta se Edge Function non funziona\r\n                if (appState.apiKey) {\r\n                    try {\r\n                        flashcards = await callApi(text);\r\n                    } catch (apiError) {\r\n                        throw new Error(`Edge Function e API diretta non disponibili: ${apiError.message}`);\r\n                    }\r\n                } else {\r\n                    throw new Error('Edge Function non disponibile e nessuna API key fornita. Configura una API key per il fallback.');\r\n                }\r\n            }\r\n        } else if (appState.useCustomApi && appState.apiKey) {\r\n            // Solo per utenti non autenticati con API key personale\r\n            showLoading(true, 'Chiamata API in corso...');\r\n            flashcards = await callApi(text);\r\n        } else {\r\n            throw new Error('Devi effettuare l\\'accesso o fornire una API key per generare flashcard.');\r\n        }\r\n        \r\n        showLoading(true, 'Validazione flashcard...');\r\n        \r\n        if (flashcards && flashcards.length > 0) {\r\n            appState.flashcards = flashcards;\r\n            appState.currentIndex = 0;\r\n            appState.answerRevealed = false;\r\n            showFlashcardSection();\r\n            updateFlashcardDisplay();\r\n            showSuccess(`Generate ${flashcards.length} flashcard con successo!`);\r\n        } else {\r\n            showError('Nessuna flashcard generata. Riprova con un testo diverso.');\r\n        }\r\n    } catch (error) {\r\n        showError('Errore nella generazione delle flashcard: ' + error.message);\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\n// Chiamata API (fallback)\r\nasync function callApi(text) {\r\n    const apiKey = appState.apiKey;\r\n    const apiUrl = CONFIG.DEFAULT_API_URL;\r\n    \r\n    if (!apiKey) {\r\n        throw new Error('API Key non configurata per il fallback');\r\n    }\r\n    \r\n    const prompt = `Genera flashcard con domande e risposte chiare e concise basate sul seguente testo. \r\n    Rispondi SOLO con un array JSON di oggetti con questa struttura esatta:\r\n    [\r\n        {\"domanda\": \"testo della domanda\", \"risposta\": \"testo della risposta\"},\r\n        {\"domanda\": \"testo della domanda\", \"risposta\": \"testo della risposta\"}\r\n    ]\r\n    \r\n    Testo da elaborare:\r\n    ${text}`;\r\n    \r\n    const requestBody = {\r\n        contents: [{\r\n            parts: [{\r\n                text: prompt\r\n            }]\r\n        }],\r\n        generationConfig: {\r\n            temperature: 0.7,\r\n            topK: 40,\r\n            topP: 0.95,\r\n            maxOutputTokens: 2048,\r\n        }\r\n    };\r\n    \r\n    const response = await fetch(`${apiUrl}?key=${apiKey}`, {\r\n        method: 'POST',\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(requestBody)\r\n    });\r\n    \r\n    if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(`Errore API: ${errorData.error?.message || response.statusText}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const generatedText = data.candidates[0].content.parts[0].text;\r\n    \r\n    // Estrai JSON dalla risposta\r\n    const jsonMatch = generatedText.match(/\\[[\\s\\S]*\\]/);\r\n    if (!jsonMatch) {\r\n        throw new Error('Formato di risposta non valido dall\\'API');\r\n    }\r\n    \r\n    try {\r\n        const flashcards = JSON.parse(jsonMatch[0]);\r\n        return flashcards.filter(card => card.domanda && card.risposta);\r\n    } catch (error) {\r\n        throw new Error('Errore nel parsing della risposta JSON');\r\n    }\r\n}\r\n\r\n// Mostra sezione flashcard\r\nfunction showFlashcardSection() {\r\n    elements.flashcardSection.classList.remove('hidden');\r\n    elements.flashcardSection.scrollIntoView({ behavior: 'smooth' });\r\n}\r\n\r\n// Aggiorna display flashcard\r\nfunction updateFlashcardDisplay() {\r\n    if (appState.flashcards.length === 0) return;\r\n    \r\n    const currentCard = appState.flashcards[appState.currentIndex];\r\n    elements.questionText.textContent = currentCard.domanda;\r\n    elements.answerText.textContent = currentCard.risposta;\r\n    \r\n    elements.currentCard.textContent = appState.currentIndex + 1;\r\n    elements.totalCards.textContent = appState.flashcards.length;\r\n    \r\n    // Reset stato risposta\r\n    appState.answerRevealed = false;\r\n    elements.answerSection.classList.add('hidden');\r\n    elements.revealAnswerBtn.classList.remove('hidden');\r\n    elements.revealAnswerBtn.textContent = '👁️ Mostra Risposta';\r\n    \r\n    // Aggiorna stato bottoni navigazione\r\n    elements.prevBtn.disabled = appState.currentIndex === 0;\r\n    elements.nextBtn.disabled = appState.currentIndex === appState.flashcards.length - 1;\r\n}\r\n\r\n// Toggle risposta\r\nfunction toggleAnswer() {\r\n    appState.answerRevealed = !appState.answerRevealed;\r\n    \r\n    if (appState.answerRevealed) {\r\n        elements.answerSection.classList.remove('hidden');\r\n        elements.answerSection.classList.add('revealed');\r\n        elements.revealAnswerBtn.textContent = '🙈 Nascondi Risposta';\r\n    } else {\r\n        elements.answerSection.classList.add('hidden');\r\n        elements.answerSection.classList.remove('revealed');\r\n        elements.revealAnswerBtn.textContent = '👁️ Mostra Risposta';\r\n    }\r\n}\r\n\r\n// Mostra flashcard precedente\r\nfunction showPreviousCard() {\r\n    if (appState.currentIndex > 0) {\r\n        appState.currentIndex--;\r\n        updateFlashcardDisplay();\r\n    }\r\n}\r\n\r\n// Mostra flashcard successiva\r\nfunction showNextCard() {\r\n    if (appState.currentIndex < appState.flashcards.length - 1) {\r\n        appState.currentIndex++;\r\n        updateFlashcardDisplay();\r\n    }\r\n}\r\n\r\n// Mostra modal salvataggio set\r\nfunction showSaveSetModal() {\r\n    if (appState.flashcards.length === 0) {\r\n        showError('Nessuna flashcard da salvare.');\r\n        return;\r\n    }\r\n    \r\n    if (!appState.user) {\r\n        showError('Devi effettuare l\\'accesso per salvare le flashcard.');\r\n        return;\r\n    }\r\n    \r\n    elements.setNameInput.value = '';\r\n    elements.saveSetModal.classList.remove('hidden');\r\n    elements.setNameInput.focus();\r\n}\r\n\r\n// Nascondi modal salvataggio set\r\nfunction hideSaveSetModal() {\r\n    elements.saveSetModal.classList.add('hidden');\r\n}\r\n\r\n// Salva set di flashcard\r\nasync function saveFlashcardSet() {\r\n    const setName = elements.setNameInput.value.trim();\r\n    if (!setName) {\r\n        showError('Inserisci un nome per il set di flashcard.');\r\n        return;\r\n    }\r\n    \r\n    if (appState.flashcards.length === 0) {\r\n        showError('Nessuna flashcard da salvare.');\r\n        return;\r\n    }\r\n    \r\n    if (!appState.user) {\r\n        showError('Devi effettuare l\\'accesso per salvare le flashcard.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true);\r\n        \r\n        // Crea il set\r\n        const { data: setData, error: setError } = await FlashcardManager.createFlashcardSet(\r\n            setName,\r\n            `Set generato il ${new Date().toLocaleDateString('it-IT')}`,\r\n            'Generale'\r\n        );\r\n        \r\n        if (setError) throw setError;\r\n        \r\n        // Aggiungi le flashcard\r\n        const { error: cardsError } = await FlashcardManager.addFlashcards(\r\n            setData.id,\r\n            appState.flashcards\r\n        );\r\n        \r\n        if (cardsError) throw cardsError;\r\n        \r\n        hideSaveSetModal();\r\n        showSuccess(`Set \"${setName}\" salvato con successo!`);\r\n        loadSavedFlashcards();\r\n        updateUserStats();\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\n// Carica flashcard salvate\r\nasync function loadSavedFlashcards() {\r\n    if (!appState.user) {\r\n        elements.emptySavedSets.classList.remove('hidden');\r\n        elements.savedSetsGrid.classList.add('hidden');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { data, error } = await FlashcardManager.getUserFlashcardSets();\r\n        if (error) throw error;\r\n        \r\n        renderSavedSets(data || []);\r\n        \r\n    } catch (error) {\r\n        console.error('Errore nel caricamento delle flashcard salvate:', error);\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Renderizza i set salvati\r\nfunction renderSavedSets(sets) {\r\n    if (sets.length === 0) {\r\n        elements.emptySavedSets.classList.remove('hidden');\r\n        elements.savedSetsGrid.classList.add('hidden');\r\n        return;\r\n    }\r\n    \r\n    elements.emptySavedSets.classList.add('hidden');\r\n    elements.savedSetsGrid.classList.remove('hidden');\r\n    \r\n    elements.savedSetsGrid.innerHTML = sets.map((set) => `\r\n        <div class=\"saved-set-card\" data-set-id=\"${set.id}\">\r\n            <div class=\"saved-set-title\">${set.name}</div>\r\n            <div class=\"saved-set-info\">\r\n                ${set.total_cards} flashcard • Creato il ${new Date(set.created_at).toLocaleDateString('it-IT')}\r\n                ${set.is_public ? ' • 🌐 Pubblico' : ''}\r\n            </div>\r\n            <div class=\"saved-set-actions\">\r\n                <button class=\"btn-secondary\" data-action=\"load\" data-set-id=\"${set.id}\">📖 Apri</button>\r\n                <button class=\"btn-secondary\" data-action=\"delete\" data-set-id=\"${set.id}\">🗑️ Elimina</button>\r\n            </div>\r\n        </div>\r\n    `).join('');\r\n    \r\n    // Aggiungi event listeners per i pulsanti\r\n    elements.savedSetsGrid.querySelectorAll('[data-action=\"load\"]').forEach(btn => {\r\n        btn.addEventListener('click', () => loadSavedSet(btn.dataset.setId));\r\n    });\r\n    \r\n    elements.savedSetsGrid.querySelectorAll('[data-action=\"delete\"]').forEach(btn => {\r\n        btn.addEventListener('click', () => deleteSavedSet(btn.dataset.setId));\r\n    });\r\n}\r\n\r\n// Carica set salvato\r\nasync function loadSavedSet(setId) {\r\n    try {\r\n        const { data, error } = await FlashcardManager.getFlashcardSet(setId);\r\n        if (error) throw error;\r\n        \r\n        if (!data) {\r\n            showError('Set non trovato.');\r\n            return;\r\n        }\r\n        \r\n        // Converti il formato Supabase al formato dell'app\r\n        appState.flashcards = data.flashcards.map(card => ({\r\n            domanda: card.question,\r\n            risposta: card.answer,\r\n            difficulty: card.difficulty\r\n        }));\r\n        \r\n        appState.currentIndex = 0;\r\n        appState.answerRevealed = false;\r\n        \r\n        showFlashcardSection();\r\n        updateFlashcardDisplay();\r\n        showSuccess(`Set \"${data.name}\" caricato con successo!`);\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Elimina set salvato\r\nasync function deleteSavedSet(setId) {\r\n    if (!confirm('Sei sicuro di voler eliminare questo set di flashcard?')) {\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { error } = await FlashcardManager.deleteFlashcardSet(setId);\r\n        if (error) throw error;\r\n        \r\n        showSuccess('Set eliminato con successo!');\r\n        loadSavedFlashcards();\r\n        updateUserStats();\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Cancella tutti i set salvati\r\nasync function clearAllSavedSets() {\r\n    if (!confirm('Sei sicuro di voler eliminare tutti i set di flashcard salvati? Questa azione non può essere annullata.')) {\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        const { data: sets, error: fetchError } = await FlashcardManager.getUserFlashcardSets();\r\n        if (fetchError) throw fetchError;\r\n        \r\n        // Elimina tutti i set\r\n        for (const set of sets) {\r\n            const { error } = await FlashcardManager.deleteFlashcardSet(set.id);\r\n            if (error) throw error;\r\n        }\r\n        \r\n        showSuccess('Tutti i set sono stati eliminati!');\r\n        loadSavedFlashcards();\r\n        updateUserStats();\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Modalità Studio\r\nasync function updateStudyStats() {\r\n    if (!appState.user) return;\r\n    \r\n    try {\r\n        const { data, error } = await AnalyticsManager.getUserAnalytics(30);\r\n        \r\n        if (error) throw error;\r\n        \r\n        const stats = data || {};\r\n        elements.cardsDue.textContent = stats.cards_due_today || 0;\r\n        elements.cardsStudied.textContent = stats.total_study_sessions || 0;\r\n        \r\n    } catch (error) {\r\n        console.error('Errore nel caricamento delle statistiche di studio:', error);\r\n    }\r\n}\r\n\r\n// Selezione modalità studio\r\nfunction selectStudyMode(event) {\r\n    const mode = event.currentTarget.dataset.mode;\r\n    \r\n    // Rimuovi selezione precedente\r\n    elements.studyModeCards.forEach(card => {\r\n        card.classList.remove('selected');\r\n    });\r\n    \r\n    // Seleziona modalità corrente\r\n    event.currentTarget.classList.add('selected');\r\n    appState.selectedStudyMode = mode;\r\n    \r\n    // Mostra pulsante inizia studio\r\n    elements.startStudyBtn.classList.remove('hidden');\r\n    \r\n    // Aggiorna modalità corrente\r\n    const modeNames = {\r\n        'spaced': 'Ripetizione Spaziata',\r\n        'quiz': 'Quiz Mode',\r\n        'matching': 'Matching',\r\n        'memory': 'Memory Game',\r\n        'speed': 'Speed Review'\r\n    };\r\n    \r\n    elements.currentStudyMode.textContent = modeNames[mode] || '-';\r\n}\r\n\r\nasync function startStudyMode() {\r\n    if (!appState.user) {\r\n        showError('Devi effettuare l\\'accesso per usare la modalità studio.');\r\n        return;\r\n    }\r\n    \r\n    if (!appState.selectedStudyMode) {\r\n        showError('Seleziona una modalità di studio prima di iniziare.');\r\n        return;\r\n    }\r\n    \r\n    try {\r\n        showLoading(true);\r\n        \r\n        // Nascondi selettore modalità\r\n        elements.studyModeSelector.classList.add('hidden');\r\n        \r\n        // Carica dati per la modalità selezionata\r\n        await loadStudyModeData();\r\n        \r\n        appState.studyMode = true;\r\n        appState.studyStartTime = Date.now();\r\n        appState.cardsStudiedToday = 0;\r\n        \r\n        elements.startStudyBtn.classList.add('hidden');\r\n        elements.stopStudyBtn.classList.remove('hidden');\r\n        \r\n        // Avvia modalità specifica\r\n        startSpecificStudyMode();\r\n        \r\n    } catch (error) {\r\n        console.error('Errore modalità studio:', error);\r\n        showError('Errore nella modalità studio. Verifica la configurazione del database.');\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\nasync function loadStudyModeData() {\r\n    if (appState.selectedStudyMode === 'spaced') {\r\n        // Modalità ripetizione spaziata - usa dati dal database\r\n        const { data, error } = await AnalyticsManager.getCardsForReview();\r\n        \r\n        if (error) {\r\n            console.warn('Modalità studio non disponibile, database non configurato:', error);\r\n            throw new Error('Modalità studio non disponibile. Configura il database per abilitare la ripetizione spaziata.');\r\n        }\r\n        \r\n        if (!data || data.length === 0) {\r\n            throw new Error('Nessuna carta da ripassare oggi! 🎉');\r\n        }\r\n        \r\n        appState.studyCards = data;\r\n        appState.currentStudyIndex = 0;\r\n        \r\n    } else {\r\n        // Altre modalità - usa flashcard salvate\r\n        const { data, error } = await FlashcardManager.getUserFlashcardSets();\r\n        \r\n        if (error || !data || data.length === 0) {\r\n            throw new Error('Nessuna flashcard salvata disponibile per questa modalità.');\r\n        }\r\n        \r\n        // Prendi il primo set disponibile\r\n        const firstSet = data[0];\r\n        const { data: setData, error: setError } = await FlashcardManager.getFlashcardSet(firstSet.id);\r\n        \r\n        if (setError || !setData || !setData.flashcards || setData.flashcards.length === 0) {\r\n            throw new Error('Nessuna flashcard disponibile nel set selezionato.');\r\n        }\r\n        \r\n        const flashcards = setData.flashcards;\r\n        \r\n        // Prepara dati per modalità specifiche\r\n        switch (appState.selectedStudyMode) {\r\n            case 'quiz':\r\n                appState.quizData = prepareQuizData(flashcards);\r\n                break;\r\n            case 'matching':\r\n                appState.matchingData = prepareMatchingData(flashcards);\r\n                break;\r\n            case 'memory':\r\n                appState.memoryData = prepareMemoryData(flashcards);\r\n                break;\r\n            case 'speed':\r\n                appState.speedData = prepareSpeedData(flashcards);\r\n                break;\r\n        }\r\n        \r\n        appState.currentStudyIndex = 0;\r\n    }\r\n}\r\n\r\nfunction startSpecificStudyMode() {\r\n    switch (appState.selectedStudyMode) {\r\n        case 'spaced':\r\n            elements.studyCard.classList.remove('hidden');\r\n            showStudyCard();\r\n            break;\r\n        case 'quiz':\r\n            elements.quizMode.classList.remove('hidden');\r\n            startQuizMode();\r\n            break;\r\n        case 'matching':\r\n            elements.matchingMode.classList.remove('hidden');\r\n            startMatchingMode();\r\n            break;\r\n        case 'memory':\r\n            elements.memoryMode.classList.remove('hidden');\r\n            startMemoryMode();\r\n            break;\r\n        case 'speed':\r\n            elements.speedMode.classList.remove('hidden');\r\n            startSpeedMode();\r\n            break;\r\n    }\r\n}\r\n\r\n// ===== PREPARAZIONE DATI MODALITÀ =====\r\n\r\nfunction prepareQuizData(flashcards) {\r\n    return flashcards.map(card => ({\r\n        question: card.question,\r\n        correctAnswer: card.answer,\r\n        options: generateQuizOptions(card.answer, flashcards),\r\n        difficulty: card.difficulty || 2\r\n    }));\r\n}\r\n\r\nfunction generateQuizOptions(correctAnswer, allCards) {\r\n    const options = [correctAnswer];\r\n    const otherAnswers = allCards\r\n        .filter(card => card.answer !== correctAnswer)\r\n        .map(card => card.answer)\r\n        .sort(() => Math.random() - 0.5)\r\n        .slice(0, 3);\r\n    \r\n    options.push(...otherAnswers);\r\n    return options.sort(() => Math.random() - 0.5);\r\n}\r\n\r\nfunction prepareMatchingData(flashcards) {\r\n    const questions = flashcards.map(card => card.question);\r\n    const answers = flashcards.map(card => card.answer);\r\n    \r\n    return {\r\n        questions: questions.sort(() => Math.random() - 0.5),\r\n        answers: answers.sort(() => Math.random() - 0.5),\r\n        pairs: flashcards.map(card => ({\r\n            question: card.question,\r\n            answer: card.answer\r\n        }))\r\n    };\r\n}\r\n\r\nfunction prepareMemoryData(flashcards) {\r\n    const cards = [];\r\n    flashcards.forEach((card, index) => {\r\n        cards.push({\r\n            id: `q${index}`,\r\n            content: card.question,\r\n            type: 'question',\r\n            pairId: index\r\n        });\r\n        cards.push({\r\n            id: `a${index}`,\r\n            content: card.answer,\r\n            type: 'answer',\r\n            pairId: index\r\n        });\r\n    });\r\n    \r\n    return cards.sort(() => Math.random() - 0.5);\r\n}\r\n\r\nfunction prepareSpeedData(flashcards) {\r\n    return flashcards.map(card => ({\r\n        question: card.question,\r\n        answer: card.answer,\r\n        difficulty: card.difficulty || 2\r\n    }));\r\n}\r\n\r\n// ===== QUIZ MODE =====\r\n\r\nfunction startQuizMode() {\r\n    appState.quizScore = 0;\r\n    appState.currentStudyIndex = 0;\r\n    showQuizQuestion();\r\n}\r\n\r\nfunction showQuizQuestion() {\r\n    const currentQuiz = appState.quizData[appState.currentStudyIndex];\r\n    if (!currentQuiz) {\r\n        endQuizMode();\r\n        return;\r\n    }\r\n    \r\n    // Aggiorna progresso\r\n    const progress = ((appState.currentStudyIndex + 1) / appState.quizData.length) * 100;\r\n    elements.quizProgress.style.width = `${progress}%`;\r\n    elements.quizProgressText.textContent = `${appState.currentStudyIndex + 1} di ${appState.quizData.length}`;\r\n    \r\n    // Mostra domanda\r\n    elements.quizQuestion.textContent = currentQuiz.question;\r\n    \r\n    // Genera opzioni\r\n    elements.quizOptions.innerHTML = '';\r\n    currentQuiz.options.forEach((option, index) => {\r\n        const optionBtn = document.createElement('button');\r\n        optionBtn.className = 'quiz-option';\r\n        optionBtn.textContent = option;\r\n        optionBtn.dataset.answer = option;\r\n        optionBtn.addEventListener('click', selectQuizAnswer);\r\n        elements.quizOptions.appendChild(optionBtn);\r\n    });\r\n    \r\n    // Nascondi feedback\r\n    elements.quizFeedback.classList.add('hidden');\r\n}\r\n\r\nfunction selectQuizAnswer(event) {\r\n    const selectedAnswer = event.target.dataset.answer;\r\n    const currentQuiz = appState.quizData[appState.currentStudyIndex];\r\n    const isCorrect = selectedAnswer === currentQuiz.correctAnswer;\r\n    \r\n    // Disabilita tutte le opzioni\r\n    document.querySelectorAll('.quiz-option').forEach(btn => {\r\n        btn.disabled = true;\r\n        if (btn.dataset.answer === currentQuiz.correctAnswer) {\r\n            btn.classList.add('correct');\r\n        } else if (btn.dataset.answer === selectedAnswer && !isCorrect) {\r\n            btn.classList.add('incorrect');\r\n        }\r\n    });\r\n    \r\n    // Mostra feedback\r\n    if (isCorrect) {\r\n        appState.quizScore++;\r\n        elements.feedbackIcon.textContent = '✅';\r\n        elements.feedbackText.textContent = 'Corretto!';\r\n        elements.correctAnswer.textContent = '';\r\n    } else {\r\n        elements.feedbackIcon.textContent = '❌';\r\n        elements.feedbackText.textContent = 'Sbagliato!';\r\n        elements.correctAnswer.textContent = `Risposta corretta: ${currentQuiz.correctAnswer}`;\r\n    }\r\n    \r\n    elements.quizFeedback.classList.remove('hidden');\r\n}\r\n\r\nfunction nextQuizQuestion() {\r\n    appState.currentStudyIndex++;\r\n    if (appState.currentStudyIndex < appState.quizData.length) {\r\n        showQuizQuestion();\r\n    } else {\r\n        endQuizMode();\r\n    }\r\n}\r\n\r\nfunction endQuizMode() {\r\n    const percentage = Math.round((appState.quizScore / appState.quizData.length) * 100);\r\n    showSuccess(`Quiz completato! Punteggio: ${appState.quizScore}/${appState.quizData.length} (${percentage}%)`);\r\n    stopStudyMode();\r\n}\r\n\r\n// ===== MATCHING MODE =====\r\n\r\nfunction startMatchingMode() {\r\n    appState.matchingScore = 0;\r\n    appState.currentStudyIndex = 0;\r\n    showMatchingGame();\r\n}\r\n\r\nfunction showMatchingGame() {\r\n    const data = appState.matchingData;\r\n    \r\n    // Aggiorna progresso\r\n    const progress = (appState.matchingScore / data.pairs.length) * 100;\r\n    elements.matchingProgress.style.width = `${progress}%`;\r\n    elements.matchingProgressText.textContent = `${appState.matchingScore} di ${data.pairs.length}`;\r\n    \r\n    // Genera griglia\r\n    elements.matchingGrid.innerHTML = '';\r\n    \r\n    // Colonna domande\r\n    const questionsColumn = document.createElement('div');\r\n    questionsColumn.className = 'matching-column';\r\n    questionsColumn.innerHTML = '<h4>Domande</h4>';\r\n    \r\n    data.questions.forEach((question, index) => {\r\n        const item = document.createElement('div');\r\n        item.className = 'matching-item';\r\n        item.textContent = question;\r\n        item.dataset.type = 'question';\r\n        item.dataset.index = index;\r\n        item.addEventListener('click', selectMatchingItem);\r\n        questionsColumn.appendChild(item);\r\n    });\r\n    \r\n    // Colonna risposte\r\n    const answersColumn = document.createElement('div');\r\n    answersColumn.className = 'matching-column';\r\n    answersColumn.innerHTML = '<h4>Risposte</h4>';\r\n    \r\n    data.answers.forEach((answer, index) => {\r\n        const item = document.createElement('div');\r\n        item.className = 'matching-item';\r\n        item.textContent = answer;\r\n        item.dataset.type = 'answer';\r\n        item.dataset.index = index;\r\n        item.addEventListener('click', selectMatchingItem);\r\n        answersColumn.appendChild(item);\r\n    });\r\n    \r\n    elements.matchingGrid.appendChild(questionsColumn);\r\n    elements.matchingGrid.appendChild(answersColumn);\r\n    \r\n    // Nascondi feedback\r\n    elements.matchingFeedback.classList.add('hidden');\r\n}\r\n\r\nlet selectedMatchingItem = null;\r\n\r\nfunction selectMatchingItem(event) {\r\n    const item = event.target;\r\n    \r\n    if (item.classList.contains('matched')) return;\r\n    \r\n    if (!selectedMatchingItem) {\r\n        // Prima selezione\r\n        selectedMatchingItem = item;\r\n        item.classList.add('selected');\r\n    } else {\r\n        // Seconda selezione\r\n        if (selectedMatchingItem === item) {\r\n            // Deseleziona se stesso\r\n            selectedMatchingItem.classList.remove('selected');\r\n            selectedMatchingItem = null;\r\n            return;\r\n        }\r\n        \r\n        // Controlla se è una coppia corretta\r\n        const isCorrect = checkMatchingPair(selectedMatchingItem, item);\r\n        \r\n        if (isCorrect) {\r\n            selectedMatchingItem.classList.add('matched');\r\n            item.classList.add('matched');\r\n            appState.matchingScore++;\r\n            \r\n            // Mostra feedback positivo\r\n            elements.matchingFeedbackIcon.textContent = '✅';\r\n            elements.matchingFeedbackText.textContent = 'Perfetto!';\r\n            elements.matchingFeedback.classList.remove('hidden');\r\n            \r\n            // Aggiorna progresso\r\n            const progress = (appState.matchingScore / appState.matchingData.pairs.length) * 100;\r\n            elements.matchingProgress.style.width = `${progress}%`;\r\n            elements.matchingProgressText.textContent = `${appState.matchingScore} di ${appState.matchingData.pairs.length}`;\r\n            \r\n            // Controlla se completato\r\n            if (appState.matchingScore === appState.matchingData.pairs.length) {\r\n                setTimeout(() => {\r\n                    showSuccess(`Matching completato! Tutte le coppie trovate! 🎉`);\r\n                    stopStudyMode();\r\n                }, 1000);\r\n            }\r\n        } else {\r\n            // Mostra feedback negativo\r\n            elements.matchingFeedbackIcon.textContent = '❌';\r\n            elements.matchingFeedbackText.textContent = 'Prova ancora!';\r\n            elements.matchingFeedback.classList.remove('hidden');\r\n            \r\n            // Rimuovi selezione dopo un po'\r\n            setTimeout(() => {\r\n                selectedMatchingItem.classList.remove('selected');\r\n                item.classList.remove('selected');\r\n            }, 1000);\r\n        }\r\n        \r\n        selectedMatchingItem = null;\r\n    }\r\n}\r\n\r\nfunction checkMatchingPair(questionItem, answerItem) {\r\n    const questionText = questionItem.textContent;\r\n    const answerText = answerItem.textContent;\r\n    \r\n    return appState.matchingData.pairs.some(pair => \r\n        pair.question === questionText && pair.answer === answerText\r\n    );\r\n}\r\n\r\n// ===== MEMORY MODE =====\r\n\r\nfunction startMemoryMode() {\r\n    appState.memoryScore = 0;\r\n    appState.memoryAttempts = 0;\r\n    appState.memoryPairs = 0;\r\n    appState.currentStudyIndex = 0;\r\n    showMemoryGame();\r\n}\r\n\r\nfunction showMemoryGame() {\r\n    const data = appState.memoryData;\r\n    \r\n    // Aggiorna progresso\r\n    const progress = (appState.memoryPairs / (data.length / 2)) * 100;\r\n    elements.memoryProgress.style.width = `${progress}%`;\r\n    elements.memoryProgressText.textContent = `${appState.memoryPairs} di ${data.length / 2}`;\r\n    \r\n    // Aggiorna statistiche\r\n    elements.memoryAttempts.textContent = appState.memoryAttempts;\r\n    elements.memoryPairs.textContent = appState.memoryPairs;\r\n    \r\n    // Genera griglia\r\n    elements.memoryGrid.innerHTML = '';\r\n    \r\n    data.forEach((card, index) => {\r\n        const memoryCard = document.createElement('div');\r\n        memoryCard.className = 'memory-card';\r\n        memoryCard.dataset.index = index;\r\n        memoryCard.dataset.pairId = card.pairId;\r\n        memoryCard.dataset.type = card.type;\r\n        memoryCard.addEventListener('click', flipMemoryCard);\r\n        elements.memoryGrid.appendChild(memoryCard);\r\n    });\r\n}\r\n\r\nlet flippedCards = [];\r\nlet memoryLocked = false;\r\n\r\nfunction flipMemoryCard(event) {\r\n    if (memoryLocked) return;\r\n    \r\n    const card = event.target;\r\n    if (card.classList.contains('flipped') || card.classList.contains('matched')) return;\r\n    \r\n    // Mostra contenuto\r\n    const cardData = appState.memoryData[card.dataset.index];\r\n    card.textContent = cardData.content;\r\n    card.classList.add('flipped');\r\n    flippedCards.push(card);\r\n    \r\n    if (flippedCards.length === 2) {\r\n        memoryLocked = true;\r\n        appState.memoryAttempts++;\r\n        elements.memoryAttempts.textContent = appState.memoryAttempts;\r\n        \r\n        const [card1, card2] = flippedCards;\r\n        \r\n        if (card1.dataset.pairId === card2.dataset.pairId) {\r\n            // Coppia corretta\r\n            setTimeout(() => {\r\n                card1.classList.add('matched');\r\n                card2.classList.add('matched');\r\n                appState.memoryPairs++;\r\n                elements.memoryPairs.textContent = appState.memoryPairs;\r\n                \r\n                // Aggiorna progresso\r\n                const progress = (appState.memoryPairs / (appState.memoryData.length / 2)) * 100;\r\n                elements.memoryProgress.style.width = `${progress}%`;\r\n                elements.memoryProgressText.textContent = `${appState.memoryPairs} di ${appState.memoryData.length / 2}`;\r\n                \r\n                // Controlla se completato\r\n                if (appState.memoryPairs === appState.memoryData.length / 2) {\r\n                    setTimeout(() => {\r\n                        showSuccess(`Memory completato! ${appState.memoryAttempts} tentativi! 🎉`);\r\n                        stopStudyMode();\r\n                    }, 1000);\r\n                }\r\n                \r\n                memoryLocked = false;\r\n            }, 500);\r\n        } else {\r\n            // Coppia sbagliata\r\n            setTimeout(() => {\r\n                card1.classList.remove('flipped');\r\n                card2.classList.remove('flipped');\r\n                card1.textContent = '';\r\n                card2.textContent = '';\r\n                memoryLocked = false;\r\n            }, 1000);\r\n        }\r\n        \r\n        flippedCards = [];\r\n    }\r\n}\r\n\r\n// ===== SPEED MODE =====\r\n\r\nfunction startSpeedMode() {\r\n    appState.speedScore = 0;\r\n    appState.currentStudyIndex = 0;\r\n    showSpeedCard();\r\n}\r\n\r\nfunction showSpeedCard() {\r\n    const currentCard = appState.speedData[appState.currentStudyIndex];\r\n    if (!currentCard) {\r\n        endSpeedMode();\r\n        return;\r\n    }\r\n    \r\n    // Aggiorna progresso\r\n    const progress = ((appState.currentStudyIndex + 1) / appState.speedData.length) * 100;\r\n    elements.speedProgress.style.width = `${progress}%`;\r\n    elements.speedProgressText.textContent = `${appState.currentStudyIndex + 1} di ${appState.speedData.length}`;\r\n    \r\n    // Mostra domanda\r\n    elements.speedQuestion.textContent = currentCard.question;\r\n    elements.speedAnswer.classList.add('hidden');\r\n    elements.speedAnswer.textContent = currentCard.answer;\r\n    \r\n    // Reset controlli\r\n    elements.revealSpeedAnswer.classList.remove('hidden');\r\n    elements.speedNext.classList.add('hidden');\r\n    \r\n    // Avvia timer\r\n    startSpeedTimer();\r\n}\r\n\r\nlet speedTimerInterval = null;\r\n\r\nfunction startSpeedTimer() {\r\n    let timeLeft = 5;\r\n    elements.speedTimer.textContent = timeLeft;\r\n    \r\n    speedTimerInterval = setInterval(() => {\r\n        timeLeft--;\r\n        elements.speedTimer.textContent = timeLeft;\r\n        \r\n        if (timeLeft <= 0) {\r\n            clearInterval(speedTimerInterval);\r\n            revealSpeedAnswer();\r\n        }\r\n    }, 1000);\r\n}\r\n\r\nfunction revealSpeedAnswer() {\r\n    if (speedTimerInterval) {\r\n        clearInterval(speedTimerInterval);\r\n    }\r\n    \r\n    elements.speedAnswer.classList.remove('hidden');\r\n    elements.revealSpeedAnswer.classList.add('hidden');\r\n    elements.speedNext.classList.remove('hidden');\r\n}\r\n\r\nfunction nextSpeedCard() {\r\n    appState.currentStudyIndex++;\r\n    if (appState.currentStudyIndex < appState.speedData.length) {\r\n        showSpeedCard();\r\n    } else {\r\n        endSpeedMode();\r\n    }\r\n}\r\n\r\nfunction endSpeedMode() {\r\n    showSuccess(`Speed Review completato! ${appState.speedData.length} carte riviste! ⚡`);\r\n    stopStudyMode();\r\n}\r\n\r\nasync function stopStudyMode() {\r\n    if (appState.studyMode && appState.studyStartTime) {\r\n        // Salva la sessione di studio\r\n        try {\r\n            const studyTime = Math.round((Date.now() - appState.studyStartTime) / 1000);\r\n            const mode = appState.selectedStudyMode || 'spaced_repetition';\r\n            \r\n            await AnalyticsManager.recordStudySession({\r\n                session_end: new Date().toISOString(),\r\n                cards_studied: appState.cardsStudiedToday,\r\n                correct_answers: appState.cardsStudiedToday, // Semplificato per ora\r\n                total_time_seconds: studyTime,\r\n                study_mode: mode\r\n            });\r\n        } catch (error) {\r\n            console.error('Errore nel salvataggio della sessione:', error);\r\n        }\r\n    }\r\n    \r\n    // Reset stato studio\r\n    appState.studyMode = false;\r\n    appState.studyCards = [];\r\n    appState.currentStudyIndex = 0;\r\n    appState.studyStartTime = null;\r\n    appState.cardsStudiedToday = 0;\r\n    appState.selectedStudyMode = null;\r\n    \r\n    // Nascondi tutte le modalità\r\n    elements.studyCard.classList.add('hidden');\r\n    elements.studyAnswer.classList.add('hidden');\r\n    elements.quizMode.classList.add('hidden');\r\n    elements.matchingMode.classList.add('hidden');\r\n    elements.memoryMode.classList.add('hidden');\r\n    elements.speedMode.classList.add('hidden');\r\n    \r\n    // Mostra selettore modalità\r\n    elements.studyModeSelector.classList.remove('hidden');\r\n    \r\n    // Reset selezione modalità\r\n    elements.studyModeCards.forEach(card => {\r\n        card.classList.remove('selected');\r\n    });\r\n    \r\n    // Mostra controlli\r\n    elements.startStudyBtn.classList.add('hidden');\r\n    elements.stopStudyBtn.classList.add('hidden');\r\n    \r\n    // Aggiorna modalità corrente\r\n    elements.currentStudyMode.textContent = '-';\r\n    \r\n    // Aggiorna statistiche\r\n    updateStudyStats();\r\n}\r\n\r\nfunction showStudyCard() {\r\n    if (appState.currentStudyIndex >= appState.studyCards.length) {\r\n        showSuccess('Hai completato tutte le carte per oggi! 🎉');\r\n        stopStudyMode();\r\n        updateStudyStats();\r\n        return;\r\n    }\r\n    \r\n    const card = appState.studyCards[appState.currentStudyIndex];\r\n    \r\n    elements.studyQuestionText.textContent = card.question;\r\n    elements.studyAnswerText.textContent = card.answer;\r\n    elements.studyAnswer.classList.add('hidden');\r\n    elements.studyRevealBtn.classList.remove('hidden');\r\n    elements.studyRevealBtn.textContent = 'Mostra Risposta';\r\n    \r\n    // Aggiorna progresso\r\n    const progress = ((appState.currentStudyIndex + 1) / appState.studyCards.length) * 100;\r\n    elements.studyProgress.style.width = `${progress}%`;\r\n    elements.studyProgressText.textContent = `${appState.currentStudyIndex + 1} di ${appState.studyCards.length}`;\r\n}\r\n\r\nfunction revealStudyAnswer() {\r\n    elements.studyAnswer.classList.remove('hidden');\r\n    elements.studyRevealBtn.classList.add('hidden');\r\n}\r\n\r\nasync function handleStudyRating(quality) {\r\n    const card = appState.studyCards[appState.currentStudyIndex];\r\n    \r\n    try {\r\n        // Calcola tempo di risposta\r\n        const responseTime = appState.studyStartTime ? \r\n            Math.round((Date.now() - appState.studyStartTime) / 1000) : null;\r\n        \r\n        // Usa algoritmo ripetizione spaziata avanzato\r\n        const { error } = await SpacedRepetition.recordStudySession(card.card_id, quality, {\r\n            responseTime: responseTime,\r\n            mode: appState.selectedStudyMode || 'spaced_repetition',\r\n            deviceType: 'desktop'\r\n        });\r\n        \r\n        if (error) throw error;\r\n        \r\n        appState.cardsStudiedToday++;\r\n        appState.currentStudyIndex++;\r\n        \r\n        // Prossima carta o fine sessione\r\n        if (appState.currentStudyIndex < appState.studyCards.length) {\r\n            showStudyCard();\r\n        } else {\r\n            showSuccess('Hai completato tutte le carte per oggi! 🎉');\r\n            stopStudyMode();\r\n        }\r\n        \r\n        // Aggiorna statistiche\r\n        updateStudyStats();\r\n        \r\n    } catch (error) {\r\n        showError(handleSupabaseError(error));\r\n    }\r\n}\r\n\r\n// Analytics Dashboard\r\nfunction showAnalyticsDashboard() {\r\n    if (!appState.user) {\r\n        showError('Devi effettuare l\\'accesso per visualizzare gli analytics.');\r\n        return;\r\n    }\r\n    \r\n    elements.analyticsSection.classList.remove('hidden');\r\n    elements.analyticsSection.scrollIntoView({ behavior: 'smooth' });\r\n    loadAnalytics();\r\n}\r\n\r\nasync function loadAnalytics() {\r\n    if (!appState.user) return;\r\n    \r\n    try {\r\n        showLoading(true, 'Caricamento analytics...');\r\n        \r\n        const daysBack = parseInt(elements.analyticsTimeframe.value);\r\n        const { data, error } = await AnalyticsManager.getUserAnalytics(daysBack);\r\n        \r\n        if (error) {\r\n            console.warn('Analytics non disponibili, mostrando dati di base:', error);\r\n            // Mostra dati di base se analytics non sono disponibili\r\n            showBasicAnalytics();\r\n            return;\r\n        }\r\n        \r\n        if (data) {\r\n            updateAnalyticsDisplay(data);\r\n            generateInsights(data);\r\n        }\r\n        \r\n    } catch (error) {\r\n        console.error('Errore analytics:', error);\r\n        showBasicAnalytics();\r\n    } finally {\r\n        showLoading(false);\r\n    }\r\n}\r\n\r\nfunction showBasicAnalytics() {\r\n    // Mostra analytics di base quando il database non è ancora configurato\r\n    elements.totalSets.textContent = '0';\r\n    elements.totalCards.textContent = '0';\r\n    elements.studyStreak.textContent = '0';\r\n    elements.accuracyRate.textContent = '0%';\r\n    elements.totalStudyTime.textContent = '0h';\r\n    elements.cardsDueToday.textContent = '0';\r\n    \r\n    elements.weeklyProgressChart.innerHTML = '<div class=\"no-data\">Database non configurato</div>';\r\n    elements.accuracyChart.innerHTML = '<div class=\"no-data\">Database non configurato</div>';\r\n    \r\n    elements.insightsList.innerHTML = `\r\n        <div class=\"insight-item\">\r\n            <div class=\"insight-icon\">⚠️</div>\r\n            <div class=\"insight-content\">\r\n                <div class=\"insight-title\">Database non configurato</div>\r\n                <div class=\"insight-description\">Esegui lo schema SQL nel dashboard Supabase per abilitare gli analytics completi.</div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction updateAnalyticsDisplay(analytics) {\r\n    // Aggiorna statistiche principali\r\n    elements.totalSets.textContent = analytics.total_sets || 0;\r\n    elements.totalCards.textContent = analytics.total_cards || 0;\r\n    elements.studyStreak.textContent = analytics.study_streak || 0;\r\n    elements.accuracyRate.textContent = `${analytics.accuracy_rate || 0}%`;\r\n    elements.totalStudyTime.textContent = `${Math.round((analytics.total_study_time || 0) / 60)}h`;\r\n    elements.cardsDueToday.textContent = analytics.cards_due_today || 0;\r\n    \r\n    // Aggiorna grafici\r\n    updateWeeklyProgressChart(analytics.weekly_progress || []);\r\n    updateAccuracyChart(analytics.weekly_progress || []);\r\n}\r\n\r\nfunction updateWeeklyProgressChart(weeklyData) {\r\n    const chart = elements.weeklyProgressChart;\r\n    \r\n    if (!weeklyData || weeklyData.length === 0) {\r\n        chart.innerHTML = '<div class=\"no-data\">Nessun dato disponibile</div>';\r\n        return;\r\n    }\r\n    \r\n    // Crea un grafico semplice con CSS\r\n    const maxCards = Math.max(...weeklyData.map(d => d.cards_studied || 0));\r\n    \r\n    chart.innerHTML = `\r\n        <div class=\"simple-chart\">\r\n            ${weeklyData.map(day => `\r\n                <div class=\"chart-bar\">\r\n                    <div class=\"bar\" style=\"height: ${((day.cards_studied || 0) / maxCards) * 100}%\"></div>\r\n                    <div class=\"bar-label\">${new Date(day.date).toLocaleDateString('it-IT', { weekday: 'short' })}</div>\r\n                </div>\r\n            `).join('')}\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction updateAccuracyChart(weeklyData) {\r\n    const chart = elements.accuracyChart;\r\n    \r\n    if (!weeklyData || weeklyData.length === 0) {\r\n        chart.innerHTML = '<div class=\"no-data\">Nessun dato disponibile</div>';\r\n        return;\r\n    }\r\n    \r\n    // Crea un grafico di accuratezza\r\n    chart.innerHTML = `\r\n        <div class=\"accuracy-chart\">\r\n            ${weeklyData.map(day => `\r\n                <div class=\"accuracy-day\">\r\n                    <div class=\"accuracy-bar\">\r\n                        <div class=\"accuracy-fill\" style=\"width: ${day.accuracy || 0}%\"></div>\r\n                    </div>\r\n                    <div class=\"accuracy-label\">${day.accuracy || 0}%</div>\r\n                </div>\r\n            `).join('')}\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction generateInsights(analytics) {\r\n    const insights = AnalyticsManager.generateInsights(analytics);\r\n    \r\n    if (insights.length === 0) {\r\n        elements.insightsList.innerHTML = `\r\n            <div class=\"insight-item\">\r\n                <div class=\"insight-icon\">🎯</div>\r\n                <div class=\"insight-content\">\r\n                    <div class=\"insight-title\">Inizia a studiare!</div>\r\n                    <div class=\"insight-description\">Crea le tue prime flashcard e inizia il tuo percorso di apprendimento.</div>\r\n                </div>\r\n            </div>\r\n        `;\r\n        return;\r\n    }\r\n    \r\n    elements.insightsList.innerHTML = insights.map(insight => `\r\n        <div class=\"insight-item\">\r\n            <div class=\"insight-icon\">${insight.icon}</div>\r\n            <div class=\"insight-content\">\r\n                <div class=\"insight-title\">${insight.title}</div>\r\n                <div class=\"insight-description\">${insight.description}</div>\r\n            </div>\r\n        </div>\r\n    `).join('');\r\n}\r\n\r\n// Mostra modal esportazione\r\nfunction showExportModal() {\r\n    elements.exportModal.classList.remove('hidden');\r\n}\r\n\r\n// Nascondi modal esportazione\r\nfunction hideExportModal() {\r\n    elements.exportModal.classList.add('hidden');\r\n}\r\n\r\n// Copia flashcard negli appunti\r\nasync function copyFlashcards() {\r\n    if (appState.flashcards.length === 0) {\r\n        showError('Nessuna flashcard da copiare.');\r\n        return;\r\n    }\r\n    \r\n    const text = appState.flashcards.map((card, index) => \r\n        `${index + 1}. Domanda: ${card.domanda}\\n   Risposta: ${card.risposta}`\r\n    ).join('\\n\\n');\r\n    \r\n    try {\r\n        await navigator.clipboard.writeText(text);\r\n        showSuccess('Flashcard copiate negli appunti!');\r\n    } catch (error) {\r\n        showError('Errore nella copia: ' + error.message);\r\n    }\r\n}\r\n\r\n// Esporta flashcard\r\nfunction exportFlashcards(format) {\r\n    if (appState.flashcards.length === 0) {\r\n        showError('Nessuna flashcard da esportare.');\r\n        return;\r\n    }\r\n    \r\n    let content, filename, mimeType;\r\n    \r\n    if (format === 'json') {\r\n        content = JSON.stringify(appState.flashcards, null, 2);\r\n        filename = 'flashcard.json';\r\n        mimeType = 'application/json';\r\n    } else if (format === 'csv') {\r\n        const csvContent = [\r\n            'Domanda,Risposta',\r\n            ...appState.flashcards.map(card => \r\n                `\"${card.domanda.replace(/\"/g, '\"\"')}\",\"${card.risposta.replace(/\"/g, '\"\"')}\"`\r\n            )\r\n        ].join('\\n');\r\n        content = csvContent;\r\n        filename = 'flashcard.csv';\r\n        mimeType = 'text/csv';\r\n    }\r\n    \r\n    const blob = new Blob([content], { type: mimeType });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = filename;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    document.body.removeChild(a);\r\n    URL.revokeObjectURL(url);\r\n    \r\n    hideExportModal();\r\n    showSuccess(`Flashcard esportate in formato ${format.toUpperCase()}!`);\r\n}\r\n\r\n// Mostra loading con progresso\r\nfunction showLoading(show, message = 'Elaborazione in corso...') {\r\n    appState.isLoading = show;\r\n    const btnText = elements.generateBtn.querySelector('.btn-text');\r\n    const spinner = elements.generateBtn.querySelector('.loading-spinner');\r\n    \r\n    if (show) {\r\n        btnText.textContent = message;\r\n        btnText.classList.remove('hidden');\r\n        spinner.classList.remove('hidden');\r\n        elements.generateBtn.disabled = true;\r\n        \r\n        // Mostra progress indicator\r\n        showProgressIndicator(message);\r\n    } else {\r\n        btnText.textContent = 'Genera Flashcard';\r\n        btnText.classList.remove('hidden');\r\n        spinner.classList.add('hidden');\r\n        elements.generateBtn.disabled = false;\r\n        \r\n        // Nascondi progress indicator\r\n        hideProgressIndicator();\r\n    }\r\n}\r\n\r\n// Progress indicator avanzato\r\nfunction showProgressIndicator(message) {\r\n    // Rimuovi indicatori esistenti\r\n    hideProgressIndicator();\r\n    \r\n    const indicator = document.createElement('div');\r\n    indicator.id = 'progress-indicator';\r\n    indicator.className = 'progress-indicator';\r\n    indicator.innerHTML = `\r\n        <div class=\"progress-content\">\r\n            <div class=\"progress-spinner\"></div>\r\n            <div class=\"progress-text\">${message}</div>\r\n            <div class=\"progress-steps\">\r\n                <div class=\"step active\" data-step=\"1\">Analisi testo</div>\r\n                <div class=\"step\" data-step=\"2\">Generazione AI</div>\r\n                <div class=\"step\" data-step=\"3\">Validazione</div>\r\n            </div>\r\n        </div>\r\n    `;\r\n    \r\n    document.body.appendChild(indicator);\r\n    \r\n    // Anima i passaggi\r\n    setTimeout(() => updateProgressStep(2), 1000);\r\n    setTimeout(() => updateProgressStep(3), 2000);\r\n}\r\n\r\nfunction updateProgressStep(step) {\r\n    const steps = document.querySelectorAll('.progress-steps .step');\r\n    steps.forEach((s, index) => {\r\n        if (index + 1 <= step) {\r\n            s.classList.add('active');\r\n        }\r\n    });\r\n}\r\n\r\nfunction hideProgressIndicator() {\r\n    const indicator = document.getElementById('progress-indicator');\r\n    if (indicator) {\r\n        indicator.remove();\r\n    }\r\n}\r\n\r\n// Mostra errore\r\nfunction showError(message) {\r\n    showNotification(message, 'error');\r\n}\r\n\r\n// Mostra successo\r\nfunction showSuccess(message) {\r\n    showNotification(message, 'success');\r\n}\r\n\r\n// Mostra notifica\r\nfunction showNotification(message, type = 'info') {\r\n    // Rimuovi notifiche esistenti\r\n    const existingNotifications = document.querySelectorAll('.notification');\r\n    existingNotifications.forEach(notification => notification.remove());\r\n    \r\n    const notification = document.createElement('div');\r\n    notification.className = `notification notification-${type}`;\r\n    notification.textContent = message;\r\n    \r\n    // Stili per la notifica\r\n    Object.assign(notification.style, {\r\n        position: 'fixed',\r\n        top: '20px',\r\n        right: '20px',\r\n        padding: '1rem 1.5rem',\r\n        borderRadius: '8px',\r\n        color: 'white',\r\n        fontWeight: '600',\r\n        zIndex: '10000',\r\n        maxWidth: '400px',\r\n        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',\r\n        transform: 'translateX(100%)',\r\n        transition: 'transform 0.3s ease'\r\n    });\r\n    \r\n    if (type === 'error') {\r\n        notification.style.backgroundColor = 'var(--accent-danger)';\r\n    } else if (type === 'success') {\r\n        notification.style.backgroundColor = 'var(--accent-secondary)';\r\n    } else {\r\n        notification.style.backgroundColor = 'var(--accent-primary)';\r\n    }\r\n    \r\n    document.body.appendChild(notification);\r\n    \r\n    // Anima l'entrata\r\n    setTimeout(() => {\r\n        notification.style.transform = 'translateX(0)';\r\n    }, 100);\r\n    \r\n    // Rimuovi dopo 5 secondi\r\n    setTimeout(() => {\r\n        notification.style.transform = 'translateX(100%)';\r\n        setTimeout(() => {\r\n            if (notification.parentNode) {\r\n                notification.parentNode.removeChild(notification);\r\n            }\r\n        }, 300);\r\n    }, 5000);\r\n}\r\n\r\n// Aggiungi toggle tema\r\nfunction addThemeToggle() {\r\n    const themeToggle = document.createElement('button');\r\n    themeToggle.className = 'theme-toggle';\r\n    themeToggle.setAttribute('aria-label', 'Cambia tema');\r\n    themeToggle.addEventListener('click', toggleTheme);\r\n    document.body.appendChild(themeToggle);\r\n}\r\n\r\n// Toggle tema\r\nfunction toggleTheme() {\r\n    const currentTheme = document.documentElement.getAttribute('data-theme');\r\n    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';\r\n    \r\n    document.documentElement.setAttribute('data-theme', newTheme);\r\n    localStorage.setItem(CONFIG.THEME_KEY, newTheme);\r\n}\r\n\r\n// Gestione errori globali\r\nwindow.addEventListener('error', (event) => {\r\n    console.error('Errore globale:', event.error);\r\n    showError('Si è verificato un errore inaspettato. Ricarica la pagina.');\r\n});\r\n\r\n// Gestione errori di rete\r\nwindow.addEventListener('unhandledrejection', (event) => {\r\n    console.error('Promise rejection non gestita:', event.reason);\r\n    showError('Errore di connessione. Verifica la tua connessione internet.');\r\n});\r\n\r\n// Listener per cambiamenti di autenticazione\r\nAuthManager.onAuthStateChange((event, session) => {\r\n    if (event === 'SIGNED_IN') {\r\n        appState.user = session.user;\r\n        showUserInfo();\r\n        loadSavedFlashcards();\r\n        updateStudyStats();\r\n    } else if (event === 'SIGNED_OUT') {\r\n        appState.user = null;\r\n        showLoginForm();\r\n    }\r\n});\r\n\r\n// Esponi funzioni globalmente per compatibilità\r\nwindow.loadSavedSet = loadSavedSet;\r\nwindow.deleteSavedSet = deleteSavedSet;\r\n"],"names":["supabase","createClient","AuthManager","signUp","email","password","data","error","auth","options","emailRedirectTo","window","location","origin","signIn","signInWithPassword","signOut","getCurrentUser","user","getUser","onAuthStateChange","callback","FlashcardManager","createFlashcardSet","name","description","subject","isPublic","Error","from","insert","user_id","id","is_public","select","single","addFlashcards","setId","flashcards","flashcardsToInsert","map","card","index","set_id","question","domanda","answer","risposta","difficulty","order_index","update","total_cards","length","eq","getUserFlashcardSets","order","ascending","getFlashcardSet","deleteFlashcardSet","delete","getPublicFlashcardSets","SpacedRepetition","calculateNext","quality","repetitions","easeFactor","interval","userStats","Object","keys","this","getUserPerformanceStats","penalty","calculatePenalty","Math","max","nextReview","Date","now","getQualityFactor","newInterval","newEaseFactor","min","consistency","personalizationFactor","getPersonalizationFactor","round","calculateDifficulty","recentErrors","avgAccuracy","accuracy","gte","toISOString","split","totalCards","reduce","sum","day","cards_studied","totalCorrect","correct_answers","incorrect_answers","studyDays","avgCardsPerDay","calculateConsistency","calculateRecentErrors","console","filter","slice","recordStudySession","cardId","sessionData","existingSession","newData","ease_factor","interval_days","sessionRecord","card_id","next_review_date","studied_at","response_time","responseTime","study_mode","mode","device_type","deviceType","upsert","onConflict","ignoreDuplicates","updateUserAnalytics","userId","today","existing","fetchError","code","updateData","date","study_time_minutes","duration","updated_at","getCardsForReview","lte","AnalyticsManager","getUserAnalytics","daysBack","rpc","user_uuid","days_back","updateDailyAnalytics","cardsStudied","correctAnswers","studyTimeMinutes","getWeeklyProgress","generateInsights","analytics","insights","study_streak","push","icon","title","accuracy_rate","total_study_time","hours","cards_due_today","total_sets","handleSupabaseError","message","includes","Recharts","LineChart","Line","XAxis","YAxis","CartesianGrid","Tooltip","Legend","ResponsiveContainer","BarChart","Bar","CONFIG","appState","currentIndex","isLoading","apiKey","useCustomApi","answerRevealed","studyMode","studyCards","currentStudyIndex","cardsStudiedToday","studyStartTime","selectedStudyMode","quizData","matchingData","memoryData","speedData","quizScore","matchingScore","memoryScore","speedScore","elements","authSection","document","getElementById","loginForm","userInfo","emailInput","passwordInput","loginBtn","signupBtn","logoutBtn","userEmail","analyticsBtn","textInput","pdfInput","pdfInfo","apiChoiceRadios","querySelectorAll","customApiSection","apiKeyInput","saveApiKeyBtn","generateBtn","flashcardSection","flashcardCounter","currentCard","questionText","answerText","answerSection","revealAnswerBtn","prevBtn","nextBtn","saveSetBtn","exportBtn","copyBtn","analyticsSection","analyticsTimeframe","refreshAnalytics","totalSets","studyStreak","accuracyRate","totalStudyTime","cardsDueToday","weeklyProgressChart","accuracyChart","insightsList","studySection","startStudyBtn","stopStudyBtn","cardsDue","currentStudyMode","studyCard","studyProgress","studyProgressText","studyQuestionText","studyRevealBtn","studyAnswer","studyAnswerText","studyModeCards","studyModeSelector","querySelector","quizMode","quizQuestion","quizOptions","quizFeedback","feedbackIcon","feedbackText","correctAnswer","nextQuizBtn","quizProgress","quizProgressText","matchingMode","matchingGrid","matchingFeedback","matchingFeedbackIcon","matchingFeedbackText","matchingProgress","matchingProgressText","memoryMode","memoryGrid","memoryAttempts","memoryPairs","memoryProgress","memoryProgressText","speedMode","speedQuestion","speedAnswer","speedTimer","revealSpeedAnswer","speedNext","speedProgress","speedProgressText","savedFlashcardsSection","savedSetsGrid","emptySavedSets","refreshSetsBtn","clearAllBtn","exportModal","exportJson","exportCsv","closeModal","saveSetModal","setNameInput","confirmSaveBtn","cancelSaveBtn","showLoginForm","classList","remove","add","showUserInfo","textContent","updateUserStats","async","stats","handleLogin","value","trim","showLoading","loadSavedFlashcards","updateStudyStats","showSuccess","showError","handleSignup","handleLogout","handleTextInput","handlePdfUpload","event","file","target","files","type","text","Promise","resolve","reject","reader","FileReader","onload","e","typedarray","Uint8Array","result","pdf","pdfjsLib","getDocument","promise","fullText","i","numPages","page","getPage","getTextContent","items","item","str","join","onerror","readAsArrayBuffer","extractTextFromPdf","size","toFixed","handleApiChoiceChange","useCustom","focus","saveApiKey","localStorage","setItem","generateFlashcards","cardCount","session","getSession","functions","invoke","body","headers","Authorization","access_token","generateFlashcardsWithAI","edgeError","warn","callApi","apiError","showFlashcardSection","updateFlashcardDisplay","apiUrl","requestBody","contents","parts","generationConfig","temperature","topK","topP","maxOutputTokens","response","fetch","method","JSON","stringify","ok","errorData","json","_a","statusText","jsonMatch","candidates","content","match","parse","scrollIntoView","behavior","disabled","toggleAnswer","showPreviousCard","showNextCard","showSaveSetModal","hideSaveSetModal","saveFlashcardSet","setName","setData","setError","toLocaleDateString","cardsError","sets","innerHTML","set","created_at","forEach","btn","addEventListener","loadSavedSet","dataset","deleteSavedSet","renderSavedSets","confirm","clearAllSavedSets","total_study_sessions","selectStudyMode","currentTarget","spaced","quiz","matching","memory","speed","startStudyMode","firstSet","generateQuizOptions","prepareQuizData","questions","answers","sort","random","pairs","prepareMatchingData","cards","pairId","prepareMemoryData","prepareSpeedData","loadStudyModeData","showStudyCard","showQuizQuestion","progress","style","width","questionsColumn","createElement","className","selectMatchingItem","appendChild","answersColumn","showMatchingGame","memoryCard","flipMemoryCard","showMemoryGame","showSpeedCard","startSpecificStudyMode","allCards","otherAnswers","currentQuiz","endQuizMode","option","optionBtn","selectQuizAnswer","selectedAnswer","isCorrect","nextQuizQuestion","percentage","stopStudyMode","GlobalWorkerOptions","workerSrc","themeToggle","setAttribute","toggleTheme","addThemeToggle","log","initializeApp","showAnalyticsDashboard","radio","showExportModal","copyFlashcards","exportFlashcards","hideExportModal","key","loadAnalytics","revealStudyAnswer","contains","handleStudyRating","parseInt","nextSpeedCard","savedApiKey","getItem","savedTheme","documentElement","loadSavedData","checkAuthState","selectedMatchingItem","questionItem","answerItem","some","pair","checkMatchingPair","setTimeout","flippedCards","memoryLocked","cardData","card1","card2","endSpeedMode","timeLeft","speedTimerInterval","setInterval","clearInterval","startSpeedTimer","studyTime","session_end","total_time_seconds","showBasicAnalytics","weeklyData","chart","maxCards","d","weekday","updateWeeklyProgressChart","weekly_progress","updateAccuracyChart","insight","navigator","clipboard","writeText","format","filename","mimeType","replace","blob","Blob","url","URL","createObjectURL","a","href","download","click","removeChild","revokeObjectURL","toUpperCase","show","btnText","spinner","hideProgressIndicator","indicator","updateProgressStep","showProgressIndicator","step","s","showNotification","notification","assign","position","top","right","padding","borderRadius","color","fontWeight","zIndex","maxWidth","boxShadow","transform","transition","backgroundColor","parentNode","newTheme","getAttribute","reason"],"mappings":"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"}