import{c as e}from"./supabase-CzEuM9Md.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const t=e("https://rixnizceeggdhlridwrj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeG5pemNlZWdnZGhscmlkd3JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNDY5MzQsImV4cCI6MjA3MzYyMjkzNH0.3YPTcW2_cfS0NCLimGpU2xpp8T5C8LPv-bluQtDB3vQ");class n{static async signUp(e,n){const{data:a,error:s}=await t.auth.signUp({email:e,password:n,options:{emailRedirectTo:window.location.origin}});return{data:a,error:s}}static async signIn(e,n){const{data:a,error:s}=await t.auth.signInWithPassword({email:e,password:n});return{data:a,error:s}}static async signOut(){const{error:e}=await t.auth.signOut();return{error:e}}static async getCurrentUser(){const{data:{user:e},error:n}=await t.auth.getUser();return{user:e,error:n}}static onAuthStateChange(e){return t.auth.onAuthStateChange(e)}}class a{static async createFlashcardSet(e,n,a,s=!1){const{data:{user:r}}=await t.auth.getUser();if(!r)throw new Error("Utente non autenticato");const{data:i,error:o}=await t.from("flashcard_sets").insert({user_id:r.id,name:e,description:n,subject:a,is_public:s}).select().single();return{data:i,error:o}}static async addFlashcards(e,n){const{data:{user:a}}=await t.auth.getUser();if(!a)throw new Error("Utente non autenticato");const s=n.map((t,n)=>({set_id:e,question:t.domanda,answer:t.risposta,difficulty:t.difficulty||2,order_index:n})),{data:r,error:i}=await t.from("flashcards").insert(s).select();return i||await t.from("flashcard_sets").update({total_cards:n.length}).eq("id",e),{data:r,error:i}}static async getUserFlashcardSets(){const{data:{user:e}}=await t.auth.getUser();if(!e)throw new Error("Utente non autenticato");const{data:n,error:a}=await t.from("flashcard_sets").select("\n        *,\n        flashcards (*)\n      ").eq("user_id",e.id).order("created_at",{ascending:!1});return{data:n,error:a}}static async getFlashcardSet(e){const{data:n,error:a}=await t.from("flashcard_sets").select("\n        *,\n        flashcards (*)\n      ").eq("id",e).single();return{data:n,error:a}}static async deleteFlashcardSet(e){const{data:{user:n}}=await t.auth.getUser();if(!n)throw new Error("Utente non autenticato");const{error:a}=await t.from("flashcard_sets").delete().eq("id",e).eq("user_id",n.id);return{error:a}}static async getPublicFlashcardSets(){const{data:e,error:n}=await t.from("flashcard_sets").select("\n        *,\n        flashcards (*)\n      ").eq("is_public",!0).order("created_at",{ascending:!1});return{data:e,error:n}}}class s{static async calculateNext(e,t=0,n=2.5,a=1,s={}){if(s&&0!==Object.keys(s).length||(s=await this.getUserPerformanceStats()||{}),e<3){const e=this.calculatePenalty(s);return{repetitions:0,interval:1,easeFactor:Math.max(1.3,n-.2-e),nextReview:new Date(Date.now()+864e5)}}this.getQualityFactor(e);let r,i=n+(.1-(5-e)*(.08+.02*(5-e)));if(i=Math.max(1.3,Math.min(3,i)),s.consistency>.8&&(i=Math.min(3,i+.1)),0===t)r=1;else if(1===t)r=6;else{const e=this.getPersonalizationFactor(s);r=Math.round(a*i*e)}return{repetitions:t+1,interval:r,easeFactor:i,nextReview:new Date(Date.now()+24*r*60*60*1e3),difficulty:this.calculateDifficulty(e,i,s)}}static calculatePenalty(e){return e.recentErrors>3?.3:e.recentErrors>1?.1:0}static getPersonalizationFactor(e){const t=e.accuracy||.8;return t>.9?1.2:t>.8?1.1:t<.6?.8:1}static getQualityFactor(e){return{5:.15,4:.1,3:.05,2:-.1,1:-.2}[e]||0}static calculateDifficulty(e,t,n){let a=2;return e>=4?a=Math.max(1,a-.5):e<=2&&(a=Math.min(5,a+.5)),t>2.5&&(a=Math.max(1,a-.3)),t<1.8&&(a=Math.min(5,a+.3)),Math.round(10*a)/10}static async getUserPerformanceStats(){try{const{data:{user:e}}=await t.auth.getUser();if(!e)return null;const{data:n,error:a}=await t.from("study_analytics").select("*").eq("user_id",e.id).gte("date",new Date(Date.now()-2592e6).toISOString().split("T")[0]).order("date",{ascending:!1});if(a)throw a;const s=n.reduce((e,t)=>e+t.cards_studied,0),r=n.reduce((e,t)=>e+t.correct_answers,0);n.reduce((e,t)=>e+t.incorrect_answers,0);return{totalCards:s,accuracy:s>0?r/s:0,studyDays:n.length,avgCardsPerDay:n.length>0?s/n.length:0,consistency:this.calculateConsistency(n),recentErrors:this.calculateRecentErrors(n)}}catch(e){return console.error("Errore nel calcolo statistiche performance:",e),null}}static calculateConsistency(e){if(e.length<3)return 0;return e.filter(e=>e.cards_studied>0).length/e.length}static calculateRecentErrors(e){return e.slice(0,3).reduce((e,t)=>e+t.incorrect_answers,0)}static async recordStudySession(e,n,a={}){const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("Utente non autenticato");const{data:r}=await t.from("study_sessions").select("*").eq("user_id",s.id).eq("card_id",e).single(),i=await this.getUserPerformanceStats();let o;o=r?await this.calculateNext(n,r.repetitions,r.ease_factor,r.interval_days,i):await this.calculateNext(n,0,2.5,1,i);const d={user_id:s.id,card_id:e,quality:n,ease_factor:o.easeFactor,interval_days:o.interval,next_review_date:o.nextReview.toISOString().split("T")[0],repetitions:o.repetitions,studied_at:(new Date).toISOString(),response_time:a.responseTime||null,study_mode:a.mode||"spaced_repetition",device_type:a.deviceType||"desktop"},{data:c,error:l}=await t.from("study_sessions").upsert(d,{onConflict:"user_id,card_id",ignoreDuplicates:!1}).select();return l||await this.updateUserAnalytics(s.id,n,a),{data:c,error:l}}static async updateUserAnalytics(e,n,a){try{const s=(new Date).toISOString().split("T")[0],{data:r,error:i}=await t.from("study_analytics").select("*").eq("user_id",e).eq("date",s).single();if(i&&"PGRST116"!==i.code)throw i;const o={user_id:e,date:s,cards_studied:((null==r?void 0:r.cards_studied)||0)+1,correct_answers:((null==r?void 0:r.correct_answers)||0)+(n>=3?1:0),incorrect_answers:((null==r?void 0:r.incorrect_answers)||0)+(n<3?1:0),study_time_minutes:((null==r?void 0:r.study_time_minutes)||0)+(a.duration||0),updated_at:(new Date).toISOString()};if(r){const{error:e}=await t.from("study_analytics").update(o).eq("id",r.id);if(e)throw e}else{const{error:e}=await t.from("study_analytics").insert(o);if(e)throw e}}catch(s){console.error("Errore nell'aggiornamento analytics:",s)}}static async getCardsForReview(){const{data:{user:e}}=await t.auth.getUser();if(!e)throw new Error("Utente non autenticato");const n=(new Date).toISOString().split("T")[0],{data:a,error:s}=await t.from("study_sessions").select("\n        *,\n        flashcards (\n          *,\n          flashcard_sets (*)\n        )\n      ").eq("user_id",e.id).lte("next_review_date",n).order("next_review_date",{ascending:!0});return{data:a,error:s}}}class r{static async getUserAnalytics(e=30){const{data:{user:n}}=await t.auth.getUser();if(!n)throw new Error("Utente non autenticato");const{data:a,error:s}=await t.rpc("get_user_analytics",{user_uuid:n.id,days_back:e});return{data:a,error:s}}static async updateDailyAnalytics(e,n,a){const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("Utente non autenticato");const r=(new Date).toISOString().split("T")[0],{data:i,error:o}=await t.from("study_analytics").upsert({user_id:s.id,date:r,cards_studied:e,correct_answers:n,incorrect_answers:e-n,study_time_minutes:a},{onConflict:"user_id,date",ignoreDuplicates:!1}).select();return{data:i,error:o}}static async getWeeklyProgress(){const{data:{user:e}}=await t.auth.getUser();if(!e)throw new Error("Utente non autenticato");const{data:n,error:a}=await t.from("study_analytics").select("*").eq("user_id",e.id).gte("date",new Date(Date.now()-6048e5).toISOString().split("T")[0]).order("date",{ascending:!0});return{data:n,error:a}}static async getCardsForReview(){const{data:{user:e}}=await t.auth.getUser();if(!e)throw new Error("Utente non autenticato");const{data:n,error:a}=await t.rpc("get_cards_for_review",{user_uuid:e.id});return{data:n,error:a}}static generateInsights(e){const t=[];if(e.study_streak>0&&t.push({icon:"🔥",title:`Streak di ${e.study_streak} giorni!`,description:e.study_streak>=7?"Fantastico! Mantieni questo ritmo per consolidare le tue conoscenze.":"Continua così! Ogni giorno di studio conta per il tuo apprendimento."}),e.accuracy_rate>0&&(e.accuracy_rate>=80?t.push({icon:"🎯",title:"Eccellente accuratezza!",description:`Con il ${e.accuracy_rate}% di risposte corrette, stai padroneggiando bene i contenuti.`}):e.accuracy_rate<60&&t.push({icon:"📚",title:"Focus sul ripasso",description:`La tua accuratezza è del ${e.accuracy_rate}%. Considera di ripassare i contenuti più difficili.`})),e.total_study_time>0){const n=Math.round(e.total_study_time/60);n>=10&&t.push({icon:"⏰",title:"Studio intensivo!",description:`Hai studiato ${n} ore negli ultimi 30 giorni. Ottimo impegno!`})}return e.cards_due_today>0&&t.push({icon:"📅",title:"Carte in attesa",description:`Hai ${e.cards_due_today} carte da ripassare oggi. Non dimenticare di studiare!`}),e.total_cards>0&&t.push({icon:"📈",title:"Progresso costante",description:`Hai creato ${e.total_cards} flashcard in ${e.total_sets} set. Continua a espandere le tue conoscenze!`}),t}}function i(e){return console.error("Supabase Error:",e),e.message.includes("JWT")?"Sessione scaduta. Effettua nuovamente l'accesso.":e.message.includes("permission")?"Non hai i permessi per eseguire questa operazione.":e.message.includes("network")?"Errore di connessione. Verifica la tua connessione internet.":e.message||"Si è verificato un errore imprevisto."}const o="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",d="flashcard_api_key",c="flashcard_theme";let l={flashcards:[],currentIndex:0,isLoading:!1,apiKey:null,useCustomApi:!1,answerRevealed:!1,user:null,studyMode:!1,studyCards:[],currentStudyIndex:0,cardsStudiedToday:0,studyStartTime:null,selectedStudyMode:null,quizData:[],matchingData:[],memoryData:[],speedData:[],quizScore:0,matchingScore:0,memoryScore:0,speedScore:0};const u={authSection:document.getElementById("authSection"),loginForm:document.getElementById("loginForm"),userInfo:document.getElementById("userInfo"),emailInput:document.getElementById("emailInput"),passwordInput:document.getElementById("passwordInput"),loginBtn:document.getElementById("loginBtn"),signupBtn:document.getElementById("signupBtn"),logoutBtn:document.getElementById("logoutBtn"),userEmail:document.getElementById("userEmail"),userStats:document.getElementById("userStats"),studyModeBtn:document.getElementById("studyModeBtn"),analyticsBtn:document.getElementById("analyticsBtn"),textInput:document.getElementById("textInput"),pdfInput:document.getElementById("pdfInput"),pdfInfo:document.getElementById("pdfInfo"),apiChoiceRadios:document.querySelectorAll('input[name="apiChoice"]'),customApiSection:document.getElementById("customApiSection"),apiKeyInput:document.getElementById("apiKeyInput"),saveApiKeyBtn:document.getElementById("saveApiKey"),generateBtn:document.getElementById("generateBtn"),flashcardSection:document.getElementById("flashcardSection"),flashcardCounter:document.getElementById("flashcardCounter"),currentCard:document.getElementById("currentCard"),totalCards:document.getElementById("totalCards"),questionText:document.getElementById("questionText"),answerText:document.getElementById("answerText"),answerSection:document.getElementById("answerSection"),revealAnswerBtn:document.getElementById("revealAnswerBtn"),hideAnswerBtn:document.getElementById("hideAnswerBtn"),prevBtn:document.getElementById("prevBtn"),nextBtn:document.getElementById("nextBtn"),saveSetBtn:document.getElementById("saveSetBtn"),exportBtn:document.getElementById("exportBtn"),copyBtn:document.getElementById("copyBtn"),analyticsSection:document.getElementById("analyticsSection"),analyticsTimeframe:document.getElementById("analyticsTimeframe"),refreshAnalytics:document.getElementById("refreshAnalytics"),totalSets:document.getElementById("totalSets"),totalCards:document.getElementById("totalCards"),studyStreak:document.getElementById("studyStreak"),accuracyRate:document.getElementById("accuracyRate"),totalStudyTime:document.getElementById("totalStudyTime"),cardsDueToday:document.getElementById("cardsDueToday"),weeklyProgressChart:document.getElementById("weeklyProgressChart"),accuracyChart:document.getElementById("accuracyChart"),insightsList:document.getElementById("insightsList"),studySection:document.getElementById("studySection"),startStudyBtn:document.getElementById("startStudyBtn"),stopStudyBtn:document.getElementById("stopStudyBtn"),cardsDue:document.getElementById("cardsDue"),cardsStudied:document.getElementById("cardsStudied"),currentStudyMode:document.getElementById("currentStudyMode"),studyCard:document.getElementById("studyCard"),studyProgress:document.getElementById("studyProgress"),studyProgressText:document.getElementById("studyProgressText"),studyQuestionText:document.getElementById("studyQuestionText"),studyRevealBtn:document.getElementById("studyRevealBtn"),studyAnswer:document.getElementById("studyAnswer"),studyAnswerText:document.getElementById("studyAnswerText"),studyModeCards:document.querySelectorAll(".study-mode-card"),studyModeSelector:document.querySelector(".study-mode-selector"),quizMode:document.getElementById("quizMode"),quizQuestion:document.getElementById("quizQuestionText"),quizOptions:document.getElementById("quizOptions"),quizFeedback:document.getElementById("quizFeedback"),feedbackIcon:document.getElementById("feedbackIcon"),feedbackText:document.getElementById("feedbackText"),correctAnswer:document.getElementById("correctAnswer"),nextQuizBtn:document.getElementById("nextQuizBtn"),quizProgress:document.getElementById("quizProgress"),quizProgressText:document.getElementById("quizProgressText"),matchingMode:document.getElementById("matchingMode"),matchingGrid:document.getElementById("matchingGrid"),matchingFeedback:document.getElementById("matchingFeedback"),matchingFeedbackIcon:document.getElementById("matchingFeedbackIcon"),matchingFeedbackText:document.getElementById("matchingFeedbackText"),matchingProgress:document.getElementById("matchingProgress"),matchingProgressText:document.getElementById("matchingProgressText"),memoryMode:document.getElementById("memoryMode"),memoryGrid:document.getElementById("memoryGrid"),memoryAttempts:document.getElementById("memoryAttempts"),memoryPairs:document.getElementById("memoryPairs"),memoryProgress:document.getElementById("memoryProgress"),memoryProgressText:document.getElementById("memoryProgressText"),speedMode:document.getElementById("speedMode"),speedQuestion:document.getElementById("speedQuestionText"),speedAnswer:document.getElementById("speedAnswerText"),speedTimer:document.getElementById("speedTimer"),revealSpeedAnswer:document.getElementById("revealSpeedAnswer"),speedNext:document.getElementById("speedNext"),speedProgress:document.getElementById("speedProgress"),speedProgressText:document.getElementById("speedProgressText"),savedFlashcardsSection:document.getElementById("savedFlashcardsSection"),savedSetsGrid:document.getElementById("savedSetsGrid"),emptySavedSets:document.getElementById("emptySavedSets"),refreshSetsBtn:document.getElementById("refreshSetsBtn"),clearAllBtn:document.getElementById("clearAllBtn"),exportModal:document.getElementById("exportModal"),exportJson:document.getElementById("exportJson"),exportCsv:document.getElementById("exportCsv"),closeModal:document.getElementById("closeModal"),saveSetModal:document.getElementById("saveSetModal"),setNameInput:document.getElementById("setNameInput"),confirmSaveBtn:document.getElementById("confirmSaveBtn"),cancelSaveBtn:document.getElementById("cancelSaveBtn")};function m(){u.loginForm.classList.remove("hidden"),u.userInfo.classList.add("hidden"),l.user=null,u.studyModeBtn.classList.add("hidden"),u.analyticsBtn.classList.add("hidden"),u.studySection.classList.add("hidden"),u.analyticsSection.classList.add("hidden");const e=document.querySelector(".api-section");if(e){e.style.opacity="1",e.style.pointerEvents="auto";const t=e.querySelector(".user-logged-tooltip");t&&t.remove()}}function y(){u.loginForm.classList.add("hidden"),u.userInfo.classList.remove("hidden"),u.userEmail.textContent=l.user.email,h(),u.studyModeBtn.classList.remove("hidden"),u.analyticsBtn.classList.remove("hidden");const e=document.querySelector(".api-section");if(e&&(e.style.opacity="0.6",e.style.pointerEvents="none",!e.querySelector(".user-logged-tooltip"))){const t=document.createElement("div");t.className="user-logged-tooltip",t.innerHTML="💡 Gli utenti loggati usano il sistema sicuro integrato",t.style.cssText="font-size: 12px; color: #666; margin-top: 5px; text-align: center;",e.appendChild(t)}}async function h(){if(l.user)try{const{data:e,error:t}=await r.getUserAnalytics(30);if(t)throw t;const n=e||{};u.userStats.textContent=`${n.total_sets||0} set • ${n.total_cards||0} carte`}catch(e){console.error("Errore nel caricamento delle statistiche:",e)}}async function p(){const e=u.emailInput.value.trim(),t=u.passwordInput.value.trim();if(e&&t)try{me(!0);const{data:a,error:s}=await n.signIn(e,t);if(s)throw s;l.user=a.user,y(),q(),$(),ge("Accesso effettuato con successo!"),u.emailInput.value="",u.passwordInput.value=""}catch(a){pe(i(a))}finally{me(!1)}else pe("Inserisci email e password.")}async function g(){const e=u.emailInput.value.trim(),t=u.passwordInput.value.trim();if(e&&t)if(t.length<6)pe("La password deve essere di almeno 6 caratteri.");else try{me(!0);const{data:a,error:s}=await n.signUp(e,t);if(s)throw s;ge("Registrazione completata! Controlla la tua email per confermare l'account."),u.emailInput.value="",u.passwordInput.value=""}catch(a){pe(i(a))}finally{me(!1)}else pe("Inserisci email e password.")}async function f(){try{const{error:e}=await n.signOut();if(e)throw e;l.user=null,m(),ge("Logout effettuato con successo!")}catch(e){pe(i(e))}}function v(){u.textInput.value.trim()&&(u.pdfInput.value="",u.pdfInfo.classList.add("hidden"))}async function w(e){const t=e.target.files[0];if(t)if("application/pdf"===t.type)try{me(!0);const e=await async function(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=async function(e){try{const n=new Uint8Array(e.target.result),a=await pdfjsLib.getDocument(n).promise;let s="";for(let e=1;e<=a.numPages;e++){const t=await a.getPage(e),n=await t.getTextContent();s+=n.items.map(e=>e.str).join(" ")+"\n"}t(s.trim())}catch(a){n(a)}},a.onerror=n,a.readAsArrayBuffer(e)})}(t);u.textInput.value=e,u.pdfInfo.textContent=`PDF caricato: ${t.name} (${(t.size/1024).toFixed(1)} KB)`,u.pdfInfo.classList.remove("hidden")}catch(n){pe("Errore nella lettura del PDF: "+n.message)}finally{me(!1)}else pe("Per favore seleziona un file PDF valido.")}function S(e){const t="custom"===e.target.value;if(l.useCustomApi=t,l.user&&t)return pe("Gli utenti loggati usano il sistema sicuro integrato. API personalizzata non necessaria."),document.querySelector('input[name="apiChoice"][value="default"]').checked=!0,void(l.useCustomApi=!1);t?(u.customApiSection.classList.remove("hidden"),u.apiKeyInput.focus()):u.customApiSection.classList.add("hidden")}function I(){const e=u.apiKeyInput.value.trim();e?(l.apiKey=e,localStorage.setItem(d,e),ge("API key salvata con successo!")):pe("Inserisci una API key valida.")}async function x(){const e=u.textInput.value.trim();if(e)if(!l.useCustomApi||l.apiKey)try{let s;if(me(!0,"Analisi del testo in corso..."),l.user){me(!0,"Generazione AI in corso...");try{const{data:n,error:a}=await async function(e,n="medio",a="",s=10){const{data:{session:r}}=await t.auth.getSession();if(!r)throw new Error("Utente non autenticato");const{data:i,error:o}=await t.functions.invoke("generate-flashcards",{body:{text:e,difficulty:n,subject:a,cardCount:s},headers:{Authorization:`Bearer ${r.access_token}`}});return{data:i,error:o}}(e,"medio","",10);if(a)throw a;s=n.flashcards}catch(n){if(console.warn("Edge Function non disponibile, fallback a API diretta:",n),!l.apiKey)throw new Error("Edge Function non disponibile e nessuna API key fornita. Configura una API key per il fallback.");try{s=await E(e)}catch(a){throw new Error(`Edge Function e API diretta non disponibili: ${a.message}`)}}}else{if(!l.useCustomApi||!l.apiKey)throw new Error("Devi effettuare l'accesso o fornire una API key per generare flashcard.");me(!0,"Chiamata API in corso..."),s=await E(e)}me(!0,"Validazione flashcard..."),s&&s.length>0?(l.flashcards=s,l.currentIndex=0,l.answerRevealed=!1,B(),L(),ge(`Generate ${s.length} flashcard con successo!`)):pe("Nessuna flashcard generata. Riprova con un testo diverso.")}catch(s){pe("Errore nella generazione delle flashcard: "+s.message)}finally{me(!1)}else pe("Inserisci la tua API key per continuare.");else pe("Inserisci del testo o carica un PDF per generare le flashcard.")}async function E(e){var t;const n=l.apiKey,a=o;if(!n)throw new Error("API Key non configurata per il fallback");const s={contents:[{parts:[{text:`Genera flashcard con domande e risposte chiare e concise basate sul seguente testo. \n    Rispondi SOLO con un array JSON di oggetti con questa struttura esatta:\n    [\n        {"domanda": "testo della domanda", "risposta": "testo della risposta"},\n        {"domanda": "testo della domanda", "risposta": "testo della risposta"}\n    ]\n    \n    Testo da elaborare:\n    ${e}`}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:2048}},r=await fetch(`${a}?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){const e=await r.json();throw new Error(`Errore API: ${(null==(t=e.error)?void 0:t.message)||r.statusText}`)}const i=(await r.json()).candidates[0].content.parts[0].text.match(/\[[\s\S]*\]/);if(!i)throw new Error("Formato di risposta non valido dall'API");try{return JSON.parse(i[0]).filter(e=>e.domanda&&e.risposta)}catch(d){throw new Error("Errore nel parsing della risposta JSON")}}function B(){u.flashcardSection.classList.remove("hidden"),u.flashcardSection.scrollIntoView({behavior:"smooth"})}function L(){if(0===l.flashcards.length)return;const e=l.flashcards[l.currentIndex];u.questionText.textContent=e.domanda,u.answerText.textContent=e.risposta,u.currentCard.textContent=l.currentIndex+1,u.totalCards.textContent=l.flashcards.length,l.answerRevealed=!1;document.getElementById("flashcard").classList.remove("flipped"),u.prevBtn.disabled=0===l.currentIndex,u.nextBtn.disabled=l.currentIndex===l.flashcards.length-1}function b(){l.answerRevealed=!l.answerRevealed;const e=document.getElementById("flashcard");l.answerRevealed?e.classList.add("flipped"):e.classList.remove("flipped")}function C(){l.answerRevealed=!1;document.getElementById("flashcard").classList.remove("flipped")}function _(){l.currentIndex>0&&(l.currentIndex--,L())}function k(){l.currentIndex<l.flashcards.length-1&&(l.currentIndex++,L())}function T(){0!==l.flashcards.length?l.user?(u.setNameInput.value="",u.saveSetModal.classList.remove("hidden"),u.setNameInput.focus()):pe("Devi effettuare l'accesso per salvare le flashcard."):pe("Nessuna flashcard da salvare.")}function M(){u.saveSetModal.classList.add("hidden")}async function A(){const e=u.setNameInput.value.trim();if(e)if(0!==l.flashcards.length)if(l.user)try{me(!0);const{data:t,error:n}=await a.createFlashcardSet(e,`Set generato il ${(new Date).toLocaleDateString("it-IT")}`,"Generale");if(n)throw n;const{error:s}=await a.addFlashcards(t.id,l.flashcards);if(s)throw s;M(),ge(`Set "${e}" salvato con successo!`),q(),h()}catch(t){pe(i(t))}finally{me(!1)}else pe("Devi effettuare l'accesso per salvare le flashcard.");else pe("Nessuna flashcard da salvare.");else pe("Inserisci un nome per il set di flashcard.")}async function q(){if(!l.user)return u.emptySavedSets.classList.remove("hidden"),void u.savedSetsGrid.classList.add("hidden");try{const{data:e,error:t}=await a.getUserFlashcardSets();if(t)throw t;!function(e){if(0===e.length)return u.emptySavedSets.classList.remove("hidden"),void u.savedSetsGrid.classList.add("hidden");u.emptySavedSets.classList.add("hidden"),u.savedSetsGrid.classList.remove("hidden"),u.savedSetsGrid.innerHTML=e.map(e=>`\n        <div class="saved-set-card" data-set-id="${e.id}">\n            <div class="saved-set-title">${e.name}</div>\n            <div class="saved-set-info">\n                ${e.total_cards} flashcard • Creato il ${new Date(e.created_at).toLocaleDateString("it-IT")}\n                ${e.is_public?" • 🌐 Pubblico":""}\n            </div>\n            <div class="saved-set-actions">\n                <button class="btn-secondary" data-action="load" data-set-id="${e.id}">📖 Apri</button>\n                <button class="btn-primary" data-action="study" data-set-id="${e.id}">🎯 Studia</button>\n                <button class="btn-secondary" data-action="delete" data-set-id="${e.id}">🗑️ Elimina</button>\n            </div>\n        </div>\n    `).join(""),u.savedSetsGrid.querySelectorAll('[data-action="load"]').forEach(e=>{e.addEventListener("click",()=>z(e.dataset.setId))}),u.savedSetsGrid.querySelectorAll('[data-action="delete"]').forEach(e=>{e.addEventListener("click",()=>P(e.dataset.setId))}),u.savedSetsGrid.querySelectorAll('[data-action="study"]').forEach(e=>{e.addEventListener("click",()=>async function(e){if(!l.user)return void pe("Devi effettuare l'accesso per usare la modalità studio.");try{me(!0,"Caricamento modalità studio...");const{data:t,error:n}=await a.getFlashcardSet(e);if(n||!t||!t.flashcards||0===t.flashcards.length)throw new Error("Impossibile caricare il set di flashcard.");l.selectedStudySet=t,l.selectedStudySetId=e,u.studySection.classList.remove("hidden"),u.studySection.scrollIntoView({behavior:"smooth"}),u.flashcardSection.classList.add("hidden"),u.analyticsSection.classList.add("hidden"),ge(`Modalità studio avviata per "${t.name}" con ${t.flashcards.length} flashcard!`)}catch(t){console.error("Errore nell'avvio dello studio:",t),pe(i(t))}finally{me(!1)}}(e.dataset.setId))})}(e||[])}catch(e){console.error("Errore nel caricamento delle flashcard salvate:",e),pe(i(e))}}async function z(e){try{const{data:t,error:n}=await a.getFlashcardSet(e);if(n)throw n;if(!t)return void pe("Set non trovato.");l.flashcards=t.flashcards.map(e=>({domanda:e.question,risposta:e.answer,difficulty:e.difficulty})),l.currentIndex=0,l.answerRevealed=!1,B(),L(),ge(`Set "${t.name}" caricato con successo!`)}catch(t){pe(i(t))}}async function P(e){if(confirm("Sei sicuro di voler eliminare questo set di flashcard?"))try{const{error:t}=await a.deleteFlashcardSet(e);if(t)throw t;ge("Set eliminato con successo!"),q(),h()}catch(t){pe(i(t))}}async function D(){if(confirm("Sei sicuro di voler eliminare tutti i set di flashcard salvati? Questa azione non può essere annullata."))try{const{data:e,error:t}=await a.getUserFlashcardSets();if(t)throw t;for(const n of e){const{error:e}=await a.deleteFlashcardSet(n.id);if(e)throw e}ge("Tutti i set sono stati eliminati!"),q(),h()}catch(e){pe(i(e))}}async function $(){if(l.user)try{const{data:e,error:t}=await r.getUserAnalytics(30);if(t)throw t;const n=e||{};u.cardsDue.textContent=n.cards_due_today||0,u.cardsStudied.textContent=n.total_study_sessions||0}catch(e){console.error("Errore nel caricamento delle statistiche di studio:",e)}}function F(e){const t=e.currentTarget.dataset.mode;u.studyModeCards.forEach(e=>{e.classList.remove("selected")}),e.currentTarget.classList.add("selected"),l.selectedStudyMode=t,u.startStudyBtn.classList.remove("hidden");u.currentStudyMode.textContent={spaced:"Ripetizione Spaziata",quiz:"Quiz Mode",matching:"Matching",memory:"Memory Game",speed:"Speed Review"}[t]||"-"}async function N(){if(l.user)if(l.selectedStudyMode)try{me(!0),u.studyModeSelector.classList.add("hidden"),await async function(){if("spaced"===l.selectedStudyMode){const{data:e,error:t}=await r.getCardsForReview();if(t)throw console.warn("Modalità studio non disponibile, database non configurato:",t),new Error("Modalità studio non disponibile. Configura il database per abilitare la ripetizione spaziata.");if(!e||0===e.length)throw new Error("Nessuna carta da ripassare oggi! 🎉");l.studyCards=e,l.currentStudyIndex=0}else{const{data:t,error:n}=await a.getUserFlashcardSets();if(n||!t||0===t.length)throw new Error("Nessuna flashcard salvata disponibile per questa modalità.");let s;if(1===t.length)s=t[0];else if(s=await(e=t,new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay",n.style.cssText="\n            position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n            background: rgba(0,0,0,0.5); display: flex; align-items: center;\n            justify-content: center; z-index: 1000;\n        ",n.innerHTML=`\n            <div class="modal-content" style="\n                background: var(--card-bg); border-radius: 12px; padding: 24px;\n                max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;\n                box-shadow: 0 10px 25px rgba(0,0,0,0.2);\n            ">\n                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\n                    <h3 style="margin: 0; color: var(--text-color);">Seleziona Set di Studio</h3>\n                    <button class="modal-close" style="\n                        background: none; border: none; font-size: 24px; cursor: pointer;\n                        color: var(--text-color); padding: 0; width: 30px; height: 30px;\n                    ">&times;</button>\n                </div>\n                <div class="modal-body">\n                    <p style="color: var(--text-color); margin-bottom: 16px;">Scegli quale set di flashcard vuoi studiare:</p>\n                    <div class="set-selection-list">\n                        ${e.map(e=>`\n                            <div class="set-option" style="\n                                border: 1px solid var(--border-color); border-radius: 8px;\n                                padding: 16px; margin-bottom: 12px; display: flex;\n                                justify-content: space-between; align-items: center;\n                                hover: background-color: var(--hover-bg);\n                            ">\n                                <div class="set-info">\n                                    <h4 style="margin: 0 0 4px 0; color: var(--text-color);">${e.name}</h4>\n                                    <p style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 14px;">${e.description||"Nessuna descrizione"}</p>\n                                    <span style="font-size: 12px; color: var(--text-secondary);">${e.total_cards||0} carte • ${e.subject||"Generale"}</span>\n                                </div>\n                                <button class="select-set-btn" data-set-id="${e.id}" style="\n                                    background: var(--primary-color); color: white; border: none;\n                                    padding: 8px 16px; border-radius: 6px; cursor: pointer;\n                                    font-size: 14px; font-weight: 500;\n                                ">\n                                    Seleziona\n                                </button>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(n),n.querySelector(".modal-close").onclick=()=>{document.body.removeChild(n),t(null)},n.onclick=e=>{e.target===n&&(document.body.removeChild(n),t(null))},n.querySelectorAll(".select-set-btn").forEach(a=>{a.onclick=()=>{const s=a.dataset.setId,r=e.find(e=>e.id===s);document.body.removeChild(n),t(r)}})})),!s)throw new Error("Nessun set selezionato.");const{data:r,error:i}=await a.getFlashcardSet(s.id);if(i||!r||!r.flashcards||0===r.flashcards.length)throw new Error("Nessuna flashcard disponibile nel set selezionato.");const o=r.flashcards;switch(l.selectedStudyMode){case"quiz":l.quizData=function(e){return e.map(t=>({question:t.question,correctAnswer:t.answer,options:U(t.answer,e),difficulty:t.difficulty||2}))}(o);break;case"matching":l.matchingData=function(e){const t=e.map(e=>e.question),n=e.map(e=>e.answer);return{questions:t.sort(()=>Math.random()-.5),answers:n.sort(()=>Math.random()-.5),pairs:e.map(e=>({question:e.question,answer:e.answer}))}}(o);break;case"memory":l.memoryData=function(e){const t=[];return e.forEach((e,n)=>{t.push({id:`q${n}`,content:e.question,type:"question",pairId:n}),t.push({id:`a${n}`,content:e.answer,type:"answer",pairId:n})}),t.sort(()=>Math.random()-.5)}(o);break;case"speed":l.speedData=function(e){return e.map(e=>({question:e.question,answer:e.answer,difficulty:e.difficulty||2}))}(o)}l.currentStudyIndex=0}var e}(),l.studyMode=!0,l.studyStartTime=Date.now(),l.cardsStudiedToday=0,u.startStudyBtn.classList.add("hidden"),u.stopStudyBtn.classList.remove("hidden"),function(){switch(l.selectedStudyMode){case"spaced":u.studyCard.classList.remove("hidden"),ne();break;case"quiz":u.quizMode.classList.remove("hidden"),l.quizScore=0,l.currentStudyIndex=0,R();break;case"matching":u.matchingMode.classList.remove("hidden"),l.matchingScore=0,l.currentStudyIndex=0,function(){const e=l.matchingData,t=l.matchingScore/e.pairs.length*100;u.matchingProgress.style.width=`${t}%`,u.matchingProgressText.textContent=`${l.matchingScore} di ${e.pairs.length}`,u.matchingGrid.innerHTML="";const n=document.createElement("div");n.className="matching-column",n.innerHTML="<h4>Domande</h4>",e.questions.forEach((e,t)=>{const a=document.createElement("div");a.className="matching-item",a.textContent=e,a.dataset.type="question",a.dataset.index=t,a.addEventListener("click",Q),n.appendChild(a)});const a=document.createElement("div");a.className="matching-column",a.innerHTML="<h4>Risposte</h4>",e.answers.forEach((e,t)=>{const n=document.createElement("div");n.className="matching-item",n.textContent=e,n.dataset.type="answer",n.dataset.index=t,n.addEventListener("click",Q),a.appendChild(n)}),u.matchingGrid.appendChild(n),u.matchingGrid.appendChild(a),u.matchingFeedback.classList.add("hidden")}();break;case"memory":u.memoryMode.classList.remove("hidden"),l.memoryScore=0,l.memoryAttempts=0,l.memoryPairs=0,l.currentStudyIndex=0,function(){const e=l.memoryData,t=l.memoryPairs/(e.length/2)*100;u.memoryProgress.style.width=`${t}%`,u.memoryProgressText.textContent=`${l.memoryPairs} di ${e.length/2}`,u.memoryAttempts.textContent=l.memoryAttempts,u.memoryPairs.textContent=l.memoryPairs,u.memoryGrid.innerHTML="",e.forEach((e,t)=>{const n=document.createElement("div");n.className="memory-card",n.dataset.index=t,n.dataset.pairId=e.pairId,n.dataset.type=e.type,n.addEventListener("click",V),u.memoryGrid.appendChild(n)})}();break;case"speed":u.speedMode.classList.remove("hidden"),l.speedScore=0,l.currentStudyIndex=0,W()}}()}catch(e){console.error("Errore modalità studio:",e),pe("Errore nella modalità studio. Verifica la configurazione del database.")}finally{me(!1)}else pe("Seleziona una modalità di studio prima di iniziare.");else pe("Devi effettuare l'accesso per usare la modalità studio.")}function U(e,t){const n=[e],a=t.filter(t=>t.answer!==e).map(e=>e.answer).sort(()=>Math.random()-.5).slice(0,3);return n.push(...a),n.sort(()=>Math.random()-.5)}function R(){const e=l.quizData[l.currentStudyIndex];if(!e)return void G();const t=(l.currentStudyIndex+1)/l.quizData.length*100;u.quizProgress.style.width=`${t}%`,u.quizProgressText.textContent=`${l.currentStudyIndex+1} di ${l.quizData.length}`,u.quizQuestion.textContent=e.question,u.quizOptions.innerHTML="",e.options.forEach((e,t)=>{const n=document.createElement("button");n.className="quiz-option",n.textContent=e,n.dataset.answer=e,n.addEventListener("click",O),u.quizOptions.appendChild(n)}),u.quizFeedback.classList.add("hidden")}function O(e){const t=e.target.dataset.answer,n=l.quizData[l.currentStudyIndex],a=t===n.correctAnswer;document.querySelectorAll(".quiz-option").forEach(e=>{e.disabled=!0,e.dataset.answer===n.correctAnswer?e.classList.add("correct"):e.dataset.answer!==t||a||e.classList.add("incorrect")}),a?(l.quizScore++,u.feedbackIcon.textContent="✅",u.feedbackText.textContent="Corretto!",u.correctAnswer.textContent=""):(u.feedbackIcon.textContent="❌",u.feedbackText.textContent="Sbagliato!",u.correctAnswer.textContent=`Risposta corretta: ${n.correctAnswer}`),u.quizFeedback.classList.remove("hidden")}function j(){l.currentStudyIndex++,l.currentStudyIndex<l.quizData.length?R():G()}function G(){const e=Math.round(l.quizScore/l.quizData.length*100);ge(`Quiz completato! Punteggio: ${l.quizScore}/${l.quizData.length} (${e}%)`),te()}document.addEventListener("DOMContentLoaded",()=>{!function(){try{pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"}catch(e){console.warn("PDF.js non disponibile:",e)}(function(){const e=document.createElement("button");e.className="theme-toggle",e.setAttribute("aria-label","Cambia tema"),e.addEventListener("click",ve),document.body.appendChild(e)})(),console.log("Flashcard Generator v2.0 inizializzato con Supabase")}(),u.loginBtn.addEventListener("click",p),u.signupBtn.addEventListener("click",g),u.logoutBtn.addEventListener("click",f),u.studyModeBtn.addEventListener("click",se),u.analyticsBtn.addEventListener("click",re),u.textInput.addEventListener("input",v),u.pdfInput.addEventListener("change",w),u.apiChoiceRadios.forEach(e=>{e.addEventListener("change",S)}),u.saveApiKeyBtn.addEventListener("click",I),u.generateBtn.addEventListener("click",x),u.revealAnswerBtn.addEventListener("click",b),u.hideAnswerBtn.addEventListener("click",C),u.prevBtn.addEventListener("click",_),u.nextBtn.addEventListener("click",k),u.saveSetBtn.addEventListener("click",T),u.exportBtn.addEventListener("click",de),u.copyBtn.addEventListener("click",le),u.exportJson.addEventListener("click",()=>ue("json")),u.exportCsv.addEventListener("click",()=>ue("csv")),u.closeModal.addEventListener("click",ce),u.confirmSaveBtn.addEventListener("click",A),u.cancelSaveBtn.addEventListener("click",M),u.setNameInput.addEventListener("keypress",e=>{"Enter"===e.key&&A()}),u.analyticsTimeframe.addEventListener("change",ie),u.refreshAnalytics.addEventListener("click",ie),u.startStudyBtn.addEventListener("click",N),u.stopStudyBtn.addEventListener("click",te),u.studyRevealBtn.addEventListener("click",ae),document.addEventListener("click",e=>{e.target.classList.contains("rating-btn")&&async function(e){const t=l.studyCards[l.currentStudyIndex];try{const n=l.studyStartTime?Math.round((Date.now()-l.studyStartTime)/1e3):null,{error:a}=await s.recordStudySession(t.card_id,e,{responseTime:n,mode:l.selectedStudyMode||"spaced_repetition",deviceType:"desktop"});if(a)throw a;l.cardsStudiedToday++,l.currentStudyIndex++,l.currentStudyIndex<l.studyCards.length?ne():(ge("Hai completato tutte le carte per oggi! 🎉"),te()),$()}catch(n){pe(i(n))}}(parseInt(e.target.dataset.quality))}),u.studyModeCards.forEach(e=>{e.addEventListener("click",F)}),u.nextQuizBtn.addEventListener("click",j),u.revealSpeedAnswer.addEventListener("click",Y),u.speedNext.addEventListener("click",Z),u.refreshSetsBtn.addEventListener("click",q),u.clearAllBtn.addEventListener("click",D),u.exportModal.addEventListener("click",e=>{e.target===u.exportModal&&ce()}),u.saveSetModal.addEventListener("click",e=>{e.target===u.saveSetModal&&M()}),function(){const e=localStorage.getItem(d);e&&(l.apiKey=e,u.apiKeyInput.value=e);const t=localStorage.getItem(c)||"light";document.documentElement.setAttribute("data-theme",t)}(),async function(){const{user:e}=await n.getCurrentUser();e?(l.user=e,y(),q(),$()):m()}()});let H=null;function Q(e){const t=e.target;if(!t.classList.contains("matched"))if(H){if(H===t)return H.classList.remove("selected"),void(H=null);if(function(e,t){const n=e.textContent,a=t.textContent;return l.matchingData.pairs.some(e=>e.question===n&&e.answer===a)}(H,t)){H.classList.add("matched"),t.classList.add("matched"),l.matchingScore++,u.matchingFeedbackIcon.textContent="✅",u.matchingFeedbackText.textContent="Perfetto!",u.matchingFeedback.classList.remove("hidden");const e=l.matchingScore/l.matchingData.pairs.length*100;u.matchingProgress.style.width=`${e}%`,u.matchingProgressText.textContent=`${l.matchingScore} di ${l.matchingData.pairs.length}`,l.matchingScore===l.matchingData.pairs.length&&setTimeout(()=>{ge("Matching completato! Tutte le coppie trovate! 🎉"),te()},1e3)}else u.matchingFeedbackIcon.textContent="❌",u.matchingFeedbackText.textContent="Prova ancora!",u.matchingFeedback.classList.remove("hidden"),setTimeout(()=>{H.classList.remove("selected"),t.classList.remove("selected")},1e3);H=null}else H=t,t.classList.add("selected")}let K=[],J=!1;function V(e){if(J)return;const t=e.target;if(t.classList.contains("flipped")||t.classList.contains("matched"))return;const n=l.memoryData[t.dataset.index];if(t.textContent=n.content,t.classList.add("flipped"),K.push(t),2===K.length){J=!0,l.memoryAttempts++,u.memoryAttempts.textContent=l.memoryAttempts;const[e,t]=K;e.dataset.pairId===t.dataset.pairId?setTimeout(()=>{e.classList.add("matched"),t.classList.add("matched"),l.memoryPairs++,u.memoryPairs.textContent=l.memoryPairs;const n=l.memoryPairs/(l.memoryData.length/2)*100;u.memoryProgress.style.width=`${n}%`,u.memoryProgressText.textContent=`${l.memoryPairs} di ${l.memoryData.length/2}`,l.memoryPairs===l.memoryData.length/2&&setTimeout(()=>{ge(`Memory completato! ${l.memoryAttempts} tentativi! 🎉`),te()},1e3),J=!1},500):setTimeout(()=>{e.classList.remove("flipped"),t.classList.remove("flipped"),e.textContent="",t.textContent="",J=!1},1e3),K=[]}}function W(){const e=l.speedData[l.currentStudyIndex];if(!e)return void ee();const t=(l.currentStudyIndex+1)/l.speedData.length*100;u.speedProgress.style.width=`${t}%`,u.speedProgressText.textContent=`${l.currentStudyIndex+1} di ${l.speedData.length}`,u.speedQuestion.textContent=e.question,u.speedAnswer.classList.add("hidden"),u.speedAnswer.textContent=e.answer,u.revealSpeedAnswer.classList.remove("hidden"),u.speedNext.classList.add("hidden"),function(){let e=5;u.speedTimer.textContent=e,X=setInterval(()=>{e--,u.speedTimer.textContent=e,e<=0&&(clearInterval(X),Y())},1e3)}()}let X=null;function Y(){X&&clearInterval(X),u.speedAnswer.classList.remove("hidden"),u.revealSpeedAnswer.classList.add("hidden"),u.speedNext.classList.remove("hidden")}function Z(){l.currentStudyIndex++,l.currentStudyIndex<l.speedData.length?W():ee()}function ee(){ge(`Speed Review completato! ${l.speedData.length} carte riviste! ⚡`),te()}async function te(){if(l.studyMode&&l.studyStartTime)try{const e=Math.round((Date.now()-l.studyStartTime)/1e3),t=l.selectedStudyMode||"spaced_repetition";await r.recordStudySession({session_end:(new Date).toISOString(),cards_studied:l.cardsStudiedToday,correct_answers:l.cardsStudiedToday,total_time_seconds:e,study_mode:t})}catch(e){console.error("Errore nel salvataggio della sessione:",e)}l.studyMode=!1,l.studyCards=[],l.currentStudyIndex=0,l.studyStartTime=null,l.cardsStudiedToday=0,l.selectedStudyMode=null,u.studyCard.classList.add("hidden"),u.studyAnswer.classList.add("hidden"),u.quizMode.classList.add("hidden"),u.matchingMode.classList.add("hidden"),u.memoryMode.classList.add("hidden"),u.speedMode.classList.add("hidden"),u.studyModeSelector.classList.remove("hidden"),u.studyModeCards.forEach(e=>{e.classList.remove("selected")}),u.startStudyBtn.classList.add("hidden"),u.stopStudyBtn.classList.add("hidden"),u.currentStudyMode.textContent="-",$()}function ne(){if(l.currentStudyIndex>=l.studyCards.length)return ge("Hai completato tutte le carte per oggi! 🎉"),te(),void $();const e=l.studyCards[l.currentStudyIndex];u.studyQuestionText.textContent=e.question,u.studyAnswerText.textContent=e.answer,u.studyAnswer.classList.add("hidden"),u.studyRevealBtn.classList.remove("hidden"),u.studyRevealBtn.textContent="Mostra Risposta";const t=(l.currentStudyIndex+1)/l.studyCards.length*100;u.studyProgress.style.width=`${t}%`,u.studyProgressText.textContent=`${l.currentStudyIndex+1} di ${l.studyCards.length}`}function ae(){u.studyAnswer.classList.remove("hidden"),u.studyRevealBtn.classList.add("hidden")}function se(){l.user?(u.flashcardSection.classList.add("hidden"),u.analyticsSection.classList.add("hidden"),u.studySection.classList.remove("hidden"),u.studySection.scrollIntoView({behavior:"smooth"}),ge("Modalità studio attivata! Seleziona una modalità per iniziare.")):pe("Devi effettuare l'accesso per usare la modalità studio.")}function re(){l.user?(u.analyticsSection.classList.remove("hidden"),u.analyticsSection.scrollIntoView({behavior:"smooth"}),ie()):pe("Devi effettuare l'accesso per visualizzare gli analytics.")}async function ie(){var e;if(l.user)try{me(!0,"Caricamento analytics...");const t=parseInt(u.analyticsTimeframe.value),{data:n,error:a}=await r.getUserAnalytics(t);if(a)return console.warn("Analytics non disponibili, mostrando dati di base:",a),void oe();n&&(e=n,u.totalSets.textContent=e.total_sets||0,u.totalCards.textContent=e.total_cards||0,u.studyStreak.textContent=e.study_streak||0,u.accuracyRate.textContent=`${e.accuracy_rate||0}%`,u.totalStudyTime.textContent=`${Math.round((e.total_study_time||0)/60)}h`,u.cardsDueToday.textContent=e.cards_due_today||0,function(e){const t=u.weeklyProgressChart;if(!e||0===e.length)return void(t.innerHTML='<div class="no-data">Nessun dato disponibile</div>');const n=Math.max(...e.map(e=>e.cards_studied||0));t.innerHTML=`\n        <div class="simple-chart">\n            ${e.map(e=>`\n                <div class="chart-bar">\n                    <div class="bar" style="height: ${(e.cards_studied||0)/n*100}%"></div>\n                    <div class="bar-label">${new Date(e.date).toLocaleDateString("it-IT",{weekday:"short"})}</div>\n                </div>\n            `).join("")}\n        </div>\n    `}(e.weekly_progress||[]),function(e){const t=u.accuracyChart;e&&0!==e.length?t.innerHTML=`\n        <div class="accuracy-chart">\n            ${e.map(e=>`\n                <div class="accuracy-day">\n                    <div class="accuracy-bar">\n                        <div class="accuracy-fill" style="width: ${e.accuracy||0}%"></div>\n                    </div>\n                    <div class="accuracy-label">${e.accuracy||0}%</div>\n                </div>\n            `).join("")}\n        </div>\n    `:t.innerHTML='<div class="no-data">Nessun dato disponibile</div>'}(e.weekly_progress||[]),function(e){const t=r.generateInsights(e);if(0===t.length)return void(u.insightsList.innerHTML='\n            <div class="insight-item">\n                <div class="insight-icon">🎯</div>\n                <div class="insight-content">\n                    <div class="insight-title">Inizia a studiare!</div>\n                    <div class="insight-description">Crea le tue prime flashcard e inizia il tuo percorso di apprendimento.</div>\n                </div>\n            </div>\n        ');u.insightsList.innerHTML=t.map(e=>`\n        <div class="insight-item">\n            <div class="insight-icon">${e.icon}</div>\n            <div class="insight-content">\n                <div class="insight-title">${e.title}</div>\n                <div class="insight-description">${e.description}</div>\n            </div>\n        </div>\n    `).join("")}(n))}catch(t){console.error("Errore analytics:",t),oe()}finally{me(!1)}}function oe(){u.totalSets.textContent="0",u.totalCards.textContent="0",u.studyStreak.textContent="0",u.accuracyRate.textContent="0%",u.totalStudyTime.textContent="0h",u.cardsDueToday.textContent="0",u.weeklyProgressChart.innerHTML='<div class="no-data">Database non configurato</div>',u.accuracyChart.innerHTML='<div class="no-data">Database non configurato</div>',u.insightsList.innerHTML='\n        <div class="insight-item">\n            <div class="insight-icon">⚠️</div>\n            <div class="insight-content">\n                <div class="insight-title">Database non configurato</div>\n                <div class="insight-description">Esegui lo schema SQL nel dashboard Supabase per abilitare gli analytics completi.</div>\n            </div>\n        </div>\n    '}function de(){u.exportModal.classList.remove("hidden")}function ce(){u.exportModal.classList.add("hidden")}async function le(){if(0===l.flashcards.length)return void pe("Nessuna flashcard da copiare.");const e=l.flashcards.map((e,t)=>`${t+1}. Domanda: ${e.domanda}\n   Risposta: ${e.risposta}`).join("\n\n");try{await navigator.clipboard.writeText(e),ge("Flashcard copiate negli appunti!")}catch(t){pe("Errore nella copia: "+t.message)}}function ue(e){if(0===l.flashcards.length)return void pe("Nessuna flashcard da esportare.");let t,n,a;if("json"===e)t=JSON.stringify(l.flashcards,null,2),n="flashcard.json",a="application/json";else if("csv"===e){t=["Domanda,Risposta",...l.flashcards.map(e=>`"${e.domanda.replace(/"/g,'""')}","${e.risposta.replace(/"/g,'""')}"`)].join("\n"),n="flashcard.csv",a="text/csv"}const s=new Blob([t],{type:a}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r,i.download=n,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),ce(),ge(`Flashcard esportate in formato ${e.toUpperCase()}!`)}function me(e,t="Elaborazione in corso..."){l.isLoading=e;const n=u.generateBtn.querySelector(".btn-text"),a=u.generateBtn.querySelector(".loading-spinner");e?(n.textContent=t,n.classList.remove("hidden"),a.classList.remove("hidden"),u.generateBtn.disabled=!0,function(e){he();const t=document.createElement("div");t.id="progress-indicator",t.className="progress-indicator",t.innerHTML=`\n        <div class="progress-content">\n            <div class="progress-spinner"></div>\n            <div class="progress-text">${e}</div>\n            <div class="progress-steps">\n                <div class="step active" data-step="1">Analisi testo</div>\n                <div class="step" data-step="2">Generazione AI</div>\n                <div class="step" data-step="3">Validazione</div>\n            </div>\n        </div>\n    `,document.body.appendChild(t),setTimeout(()=>ye(2),1e3),setTimeout(()=>ye(3),2e3)}(t)):(n.textContent="Genera Flashcard",n.classList.remove("hidden"),a.classList.add("hidden"),u.generateBtn.disabled=!1,he())}function ye(e){document.querySelectorAll(".progress-steps .step").forEach((t,n)=>{n+1<=e&&t.classList.add("active")})}function he(){const e=document.getElementById("progress-indicator");e&&e.remove()}function pe(e){fe(e,"error")}function ge(e){fe(e,"success")}function fe(e,t="info"){document.querySelectorAll(".notification").forEach(e=>e.remove());const n=document.createElement("div");n.className=`notification notification-${t}`,n.textContent=e,Object.assign(n.style,{position:"fixed",top:"20px",right:"20px",padding:"1rem 1.5rem",borderRadius:"8px",color:"white",fontWeight:"600",zIndex:"10000",maxWidth:"400px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",transform:"translateX(100%)",transition:"transform 0.3s ease"}),n.style.backgroundColor="error"===t?"var(--accent-danger)":"success"===t?"var(--accent-secondary)":"var(--accent-primary)",document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateX(0)"},100),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},5e3)}function ve(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem(c,e)}window.addEventListener("error",e=>{console.error("Errore globale:",e.error),pe("Si è verificato un errore inaspettato. Ricarica la pagina.")}),window.addEventListener("unhandledrejection",e=>{console.error("Promise rejection non gestita:",e.reason),pe("Errore di connessione. Verifica la tua connessione internet.")}),n.onAuthStateChange((e,t)=>{"SIGNED_IN"===e?(l.user=t.user,y(),q(),$()):"SIGNED_OUT"===e&&(l.user=null,m())}),window.loadSavedSet=z,window.deleteSavedSet=P;
//# sourceMappingURL=main-eJNN6Bpg.js.map
